<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Monka Simulator V3 ‚Äì Multi-Vuln√©rabilit√©</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --card-bg: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
        }

        header h1 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        /* Vulnerability Selector */
        .vuln-selector {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            border: 2px solid var(--primary);
        }

        .vuln-selector h4 {
            color: var(--primary);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .vuln-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        .vuln-btn {
            padding: 0.75rem 0.5rem;
            border-radius: 0.5rem;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
        }

        .vuln-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .vuln-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .vuln-btn .code {
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        /* Persona Selector */
        .persona-selector {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            border: 2px solid #8b5cf6;
        }

        .persona-selector h4 {
            color: #8b5cf6;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .persona-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        .persona-card {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid var(--border);
            background: var(--bg);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .persona-card:hover {
            border-color: #8b5cf6;
        }

        .persona-card.active {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        .persona-card .emoji {
            font-size: 1.5rem;
        }

        .persona-card .name {
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        .persona-card .badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-top: 0.25rem;
            display: inline-block;
        }

        .persona-card .badge.urgent {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .persona-card .badge.prioritaire {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .persona-card .badge.planifie {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .persona-card .badge.critique {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .persona-card .badge.sain {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .persona-info {
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            margin-top: 0.75rem;
            display: none;
        }

        .persona-info.visible {
            display: block;
        }

        /* Scrollable content */
        .scrollable {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        /* Question Card */
        .question-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--border);
        }

        .question-card.scorante {
            border-left-color: var(--primary);
        }

        .question-card.declenchante {
            border-left-color: var(--danger);
        }

        .question-card.descriptive {
            border-left-color: var(--text-muted);
        }

        .question-id {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .question-id.scorante {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .question-id.declenchante {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .question-id.descriptive {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-muted);
        }

        .question-label {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: var(--bg);
            border-radius: 0.5rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .option:hover {
            border-color: var(--primary);
        }

        .option.selected {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
        }

        .option.critical-selected {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--danger);
        }

        .option .radio {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--text-muted);
            flex-shrink: 0;
        }

        .option.selected .radio,
        .option.critical-selected .radio {
            border-color: var(--primary);
            background: var(--primary);
        }

        .option-score {
            margin-left: auto;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .option-score.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Tabs */
        .tabs-section {
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }

        .tabs-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .tabs-label.external {
            color: var(--success);
        }

        .tabs-label.internal {
            color: #3b82f6;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background: var(--bg);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--card-bg);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Result sections */
        .result-section {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .result-section h4 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        /* Score Display */
        .score-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 0.75rem;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .score-circle.green {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 3px solid var(--success);
        }

        .score-circle.orange {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 3px solid var(--warning);
        }

        .score-circle.red {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 3px solid var(--danger);
        }

        .score-details {
            flex: 1;
        }

        .score-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .score-interpretation {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Priority Badge */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .priority-badge.level-1 {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .priority-badge.level-2 {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .priority-badge.level-3 {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        /* CCC Items */
        .ccc-item {
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.85rem;
            border-left: 3px solid transparent;
        }

        .ccc-item.activated {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--danger);
        }

        .ccc-status {
            font-size: 1.1rem;
        }

        .ccc-code {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.75rem;
        }

        .ccc-name {
            flex: 1;
        }

        /* ASR Items */
        .asr-item {
            padding: 1rem;
            background: var(--bg);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--border);
        }

        .asr-item.activated {
            border-left-color: var(--success);
        }

        .asr-code {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .asr-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .asr-objective {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Recommendations */
        .reco-item {
            background: var(--bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--success);
        }

        .reco-item.urgent {
            border-left-color: var(--danger);
        }

        .reco-item.prioritaire {
            border-left-color: var(--warning);
        }

        .reco-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .reco-priority {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .reco-priority.urgent {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .reco-priority.prioritaire {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .reco-priority.planifie {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .reco-text {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .reco-actor {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .micro-task {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 0.25rem 0;
        }

        .micro-task::before {
            content: '‚Üí';
            color: var(--success);
        }

        /* Rules */
        .rule-item {
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.6;
        }

        .rule-item.active {
            opacity: 1;
        }

        .rule-code {
            font-family: monospace;
            color: #a78bfa;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .actions {
            margin-top: 1rem;
            text-align: center;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üß™ Monka Simulator V3</h1>
            <p id="header-subtitle">Chargement...</p>
        </header>

        <div class="grid">
            <!-- LEFT: Questionnaire -->
            <div class="panel">
                <div class="panel-title">
                    <span>üìã</span>
                    <span>Questionnaire Aidant</span>
                </div>

                <!-- Vulnerability Selector -->
                <div class="vuln-selector">
                    <h4>üéØ Choisir une Vuln√©rabilit√©</h4>
                    <div class="vuln-grid">
                        <div class="vuln-btn active" onclick="loadVulnerability('V1')">
                            <span class="code">V1</span>
                            Social
                        </div>
                        <div class="vuln-btn" onclick="loadVulnerability('V2')">
                            <span class="code">V2</span>
                            Fragilit√©
                        </div>
                        <div class="vuln-btn" onclick="loadVulnerability('V3')">
                            <span class="code">V3</span>
                            Sant√© Aidant
                        </div>
                        <div class="vuln-btn" onclick="loadVulnerability('V4')">
                            <span class="code">V4</span>
                            Sant√© Proche
                        </div>
                        <div class="vuln-btn" onclick="loadVulnerability('V5')">
                            <span class="code">V5</span>
                            Admin
                        </div>
                    </div>
                </div>

                <!-- Persona Selector -->
                <div class="persona-selector">
                    <h4>
                        üé≠ Tester avec un Persona
                        <button onclick="resetAll()"
                            style="margin-left: auto; padding: 4px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; cursor: pointer; color: var(--text);">
                            üîÑ R√©initialiser
                        </button>
                    </h4>
                    <div class="persona-grid" id="persona-grid">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="persona-info" id="persona-info"></div>
                </div>

                <div class="scrollable" id="questionnaire">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des questions...</p>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="resetAll()">üîÑ R√©initialiser</button>
                </div>
            </div>

            <!-- RIGHT: Results -->
            <div class="panel">
                <div class="panel-title">
                    <span>‚öôÔ∏è</span>
                    <span>Moteur Monka</span>
                </div>

                <!-- Tab Navigation -->
                <div class="tabs-section">
                    <div class="tabs-label external">üë§ VUE EXTERNE (Visible Aidant)</div>
                    <div class="tabs">
                        <div class="tab" onclick="switchTab('recos')">üí° Recommandations</div>
                        <div class="tab" onclick="switchTab('asr')">üéØ Mes objectifs (ASR)</div>
                    </div>
                </div>

                <div class="tabs-section">
                    <div class="tabs-label internal">üè• VUE INTERNE (IDEC Professionnel)</div>
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('scoring')">üìä Scoring</div>
                        <div class="tab" onclick="switchTab('critical')">‚ö†Ô∏è Critiques</div>
                        <div class="tab" onclick="switchTab('ccc')">üîó CCC</div>
                        <div class="tab" onclick="switchTab('mp')">üõ£Ô∏è Micro-parcours</div>
                        <div class="tab" onclick="switchTab('mt')">üìù Micro-t√¢ches</div>
                        <div class="tab" onclick="switchTab('justif')">‚öñÔ∏è Justification</div>
                    </div>
                </div>

                <div class="scrollable">
                    <!-- Scoring Tab -->
                    <div class="tab-content active" id="tab-scoring">
                        <div class="result-section">
                            <h4>Score Vuln√©rabilit√©</h4>
                            <div class="score-display">
                                <div class="score-circle green" id="score-circle">
                                    <span id="score-value">0</span>
                                </div>
                                <div class="score-details">
                                    <div class="score-label">Score brut: <span id="score-raw">0</span>/<span
                                            id="score-max">13</span></div>
                                    <div class="score-interpretation" id="score-interpretation">R√©pondez aux questions
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Priorit√© calcul√©e</h4>
                            <div id="priority-display">
                                <div class="priority-badge level-3">
                                    <span>‚è±Ô∏è</span>
                                    <span>Niveau 3 ‚Äì Planifi√© (>1 mois)</span>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>D√©tail scoring par question</h4>
                            <div id="scoring-details"></div>
                        </div>
                    </div>

                    <!-- Critical Tab -->
                    <div class="tab-content" id="tab-critical">
                        <div class="result-section">
                            <h4>Questions Critiques Directes</h4>
                            <div id="critical-list">
                                <div class="empty-state">
                                    <div class="icon">‚úÖ</div>
                                    <p>Aucune alerte critique</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CCC Tab -->
                    <div class="tab-content" id="tab-ccc">
                        <div class="result-section">
                            <h4>Conditions Critiques Composites (CCC)</h4>
                            <div id="ccc-list"></div>
                        </div>
                    </div>

                    <!-- Micro-Parcours (MP) Tab -->
                    <div class="tab-content" id="tab-mp">
                        <div class="result-section">
                            <h4>Micro-parcours activ√©s</h4>
                            <div id="mp-list"></div>
                        </div>
                    </div>

                    <!-- Micro-Tasks (MT) Tab -->
                    <div class="tab-content" id="tab-mt">
                        <div class="result-section">
                            <h4>Micro-t√¢ches Recommand√©es</h4>
                            <div id="mt-list">
                                <div class="empty-state">
                                    <p>R√©pondez pour voir les micro-t√¢ches</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations Tab -->
                    <div class="tab-content" id="tab-recos">
                        <div id="reco-list">
                            <div class="empty-state">
                                <div class="icon">üí°</div>
                                <p>R√©pondez aux questions pour voir les recommandations</p>
                            </div>
                        </div>
                    </div>

                    <!-- ASR Tab -->
                    <div class="tab-content" id="tab-asr">
                        <div class="result-section"
                            style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: white; font-size: 1rem;">üéØ Vos objectifs de s√©curisation</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 0.8rem; margin-top: 0.5rem;">
                                Ces objectifs repr√©sentent les changements concrets √† atteindre.
                            </p>
                        </div>
                        <div id="asr-list"></div>
                    </div>

                    <!-- Justification Tab (Rules) -->
                    <div class="tab-content" id="tab-justif">
                        <div class="result-section">
                            <h4>üìú Justification & R√®gles</h4>
                            <div id="rules-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // MONKA SIMULATOR V3 - DATA-DRIVEN ENGINE
        // ============================================

        let DATA = null; // Loaded dynamically
        let answers = {};
        let currentVulnerability = 'V1';

        // Load vulnerability data from JSON
        async function loadVulnerability(code) {
            currentVulnerability = code;
            answers = {};

            // Update UI
            document.querySelectorAll('.vuln-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(code)) btn.classList.add('active');
            });

            document.getElementById('questionnaire').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement ${code}...</p>
                </div>
            `;

            try {
                const response = await fetch(`./data/${code}/simulator_data.json`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                DATA = await response.json();
                init();
            } catch (error) {
                document.getElementById('questionnaire').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <p>Donn√©es ${code} non disponibles</p>
                        <p style="font-size: 0.75rem; margin-top: 0.5rem;">Fichier: data/${code}/simulator_data.json</p>
                    </div>
                `;
                console.error(`Erreur chargement ${code}:`, error);
            }
        }

        function init() {
            if (!DATA) return;

            // Update header
            document.getElementById('header-subtitle').textContent =
                `Test interactif ‚Äì ${DATA.metadata ? DATA.metadata.name : 'Vuln√©rabilit√©'}`;

            // Render all components
            renderPersonas();
            renderQuestions();
            renderCCC();
            renderASR();
            renderRules();
            updateResults();
        }



        function renderPersonas() {
            const container = document.getElementById('persona-grid');
            if (!DATA.personas || DATA.personas.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.75rem;">Aucun persona</p>';
                return;
            }

            container.innerHTML = DATA.personas.map((p, idx) => `
                <div class="persona-card" onclick="loadPersona(${idx})">
                    <div class="emoji">üë§</div>
                    <div class="name">${p.name}</div>
                    <div class="badge ${p.priority_badge}">${p.priority_badge}</div>
                </div>
            `).join('');
        }

        function loadPersona(idx) {
            const persona = DATA.personas[idx];
            if (!persona) return;

            // Mark active
            document.querySelectorAll('.persona-card').forEach((c, i) => {
                c.classList.toggle('active', i === idx);
            });

            // Show info
            const info = document.getElementById('persona-info');
            info.innerHTML = `
                <strong>${persona.name}</strong><br>
                ${persona.description}<br>
                <span class="badge ${persona.priority_badge}" style="margin-top: 0.5rem;">${persona.priority_badge}</span>
                <span style="margin-left: 0.5rem;">${persona.ccc_count} CCC attendues</span>
            `;
            info.classList.add('visible');

            // Apply answers
            answers = {};
            Object.entries(persona.responses).forEach(([qId, optCode]) => {
                const q = DATA.questions.find(q => q.id === qId);
                if (q) {
                    const optIdx = q.options.findIndex(o => o.code === optCode);
                    if (optIdx >= 0) {
                        selectOption(qId, optIdx, false);
                    }
                }
            });

            updateResults();
        }

        function renderQuestions() {
            const container = document.getElementById('questionnaire');
            if (!DATA.questions || DATA.questions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>Aucune question</p></div>';
                return;
            }

            container.innerHTML = DATA.questions.map(q => `
                <div class="question-card ${q.type}">
                    <span class="question-id ${q.type}">
                        ${q.id} ‚Äì ${q.type === 'scorante' ? 'üìä Scorante' : q.type === 'declenchante' ? '‚ö†Ô∏è Critique' : 'üìã Descriptive'}
                    </span>
                    <div class="question-label">${q.label || q.text}</div>
                    <div class="options">
                        ${q.options.map((opt, optIdx) => {
                // Check criticality dynamically from Triggers
                const isCritical = DATA.triggers?.critical_direct?.some(t => t.question_id === q.id && t.option === opt.code);

                return `
                            <label class="option" id="opt-${q.id}-${optIdx}" onclick="selectOption('${q.id}', ${optIdx})">
                                <div class="radio"></div>
                                <span>${opt.label}</span>
                                ${opt.score > 0 ? `<span class="option-score">+${opt.score}</span>` : ''}
                                ${isCritical ? '<span class="option-score critical">üî¥ Critique</span>' : ''}
                            </label>
                            `;
            }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectOption(qId, optIdx, shouldUpdate = true) {
            const q = DATA.questions.find(q => q.id === qId);
            if (!q) return;

            const opt = q.options[optIdx];
            answers[qId] = {
                optionIndex: optIdx,
                optionCode: opt.code,
                score: opt.score || 0
            };

            // Update UI
            q.options.forEach((_, idx) => {
                const el = document.getElementById(`opt-${qId}-${idx}`);
                if (el) el.classList.remove('selected', 'critical-selected');
            });

            // Check if selected option is critical
            const isCritical = DATA.triggers?.critical_direct?.some(t => t.question_id === qId && t.option === opt.code);
            const selectedEl = document.getElementById(`opt-${qId}-${optIdx}`);
            if (selectedEl) {
                selectedEl.classList.add(isCritical ? 'critical-selected' : 'selected');
            }

            if (shouldUpdate) updateResults();
        }

        function updateResults() {
            if (!DATA) return;

            // Calculate score
            let rawScore = 0;
            const scoringQuestions = DATA.scoring?.questions || [];
            // If scoring.questions is object, take keys, if list take list
            const scoringList = Array.isArray(scoringQuestions) ? scoringQuestions : Object.keys(scoringQuestions);
            const maxScore = DATA.scoring?.max_score || 0;

            Object.entries(answers).forEach(([qId, ans]) => {
                // Only add if scorante? Or just add all scores?
                // Legacy: specific list. New: q.options has score.
                rawScore += ans.score;
            });

            // Update score display
            document.getElementById('score-raw').textContent = rawScore;
            document.getElementById('score-max').textContent = maxScore > 0 ? maxScore : '-';
            document.getElementById('score-value').textContent = rawScore;

            // Determine threshold
            const circle = document.getElementById('score-circle');
            circle.classList.remove('green', 'orange', 'red');

            let interpretation = 'R√©pondez aux questions';
            const thresholds = DATA.scoring?.thresholds || [];
            for (const t of thresholds) {
                if (rawScore >= t.min && rawScore <= t.max) {
                    circle.classList.add(t.color);
                    interpretation = `${t.color === 'green' ? 'üü¢' : t.color === 'orange' ? 'üü†' : 'üî¥'} ${t.label}`;
                    break;
                }
            }
            document.getElementById('score-interpretation').textContent = interpretation;

            // Check Critical Direct Triggers
            let criticalMessages = [];
            DATA.triggers?.critical_direct?.forEach(t => {
                const ans = answers[t.question_id];
                if (ans && ans.optionCode === t.option) {
                    const q = DATA.questions.find(q => q.id === t.question_id);
                    const optLabel = q?.options.find(o => o.code === t.option)?.label || t.option_label;
                    criticalMessages.push(`${t.question_id}: ${optLabel}`);
                }
            });
            const hasCritical = criticalMessages.length > 0;

            // Check Micro-Parcours (Standard Triggers)
            let activatedMPs = new Set();
            DATA.triggers?.standard?.forEach(t => {
                const ans = answers[t.question_id];
                if (ans && ans.optionCode === t.option) {
                    activatedMPs.add(t.micro_parcours);
                }
            });

            // Update critical list UI
            if (hasCritical) {
                document.getElementById('critical-list').innerHTML = criticalMessages.map(msg => `
                    <div class="ccc-item activated">
                        <span class="ccc-status">üö®</span>
                        <span>${msg}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('critical-list').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <p>Aucune alerte critique</p>
                    </div>
                `;
            }

            // Check CCC (simplified)
            // CCC logic: "conditions": [{"question_id": "...", "option_label": "..."}]
            // Wait, CCC in JSON V3 uses 'option_label' for check. But answers use 'optionCode'.
            // WE NEED TO MAP CCC CONDITIONS TO CODES TOO OR FAKE IT.
            // Since we didn't map CCC yet, let's try to match by Label or fallback.
            // Actually `generate_json_v3.py` left CCC conditions as Option LABELS.
            // This is a GAP. 
            // Workaround: We match label against current answer label.

            let activatedCCC = [];
            DATA.ccc?.forEach(ccc => {
                // A CCC is activated if ALL its conditions are met
                const allMet = ccc.conditions?.every(cond => {
                    const ans = answers[cond.question_id];
                    if (!ans) return false;
                    const q = DATA.questions.find(q => q.id === cond.question_id);
                    const selectedOpt = q?.options[ans.optionIndex];
                    // Flexible match
                    return selectedOpt && cleanText(selectedOpt.label) === cleanText(cond.option_label || "");
                });

                const el = document.getElementById(`ccc-${ccc.id}`);
                if (el) {
                    if (allMet) {
                        el.classList.add('activated');
                        el.querySelector('.ccc-status').textContent = 'üî¥';
                        activatedCCC.push(ccc);
                    } else {
                        el.classList.remove('activated');
                        el.querySelector('.ccc-status').textContent = '‚¨ú';
                    }
                }
            });

            // Priority Calculation
            let priorityLabel = 'Niveau 3 ‚Äì Planifi√© (>1 mois)';
            let priorityClass = 'level-3';
            let priorityIcon = '‚è±Ô∏è';

            if (hasCritical) {
                priorityLabel = 'Niveau 1 ‚Äì URGENT (‚â§ 7 jours)';
                priorityClass = 'level-1';
                priorityIcon = 'üö®';
            } else if (activatedCCC.length > 0) { // Or Score based logic
                priorityLabel = 'Niveau 2 ‚Äì Prioritaire (‚â§ 1 mois)';
                priorityClass = 'level-2';
                priorityIcon = '‚ö°';
            }

            document.getElementById('priority-display').innerHTML = `
                <div class="priority-badge ${priorityClass}">
                    <span>${priorityIcon}</span>
                    <span>${priorityLabel}</span>
                </div>
            `;

            // Render activated MPs
            document.getElementById('mp-list').innerHTML = Array.from(activatedMPs).map(mp => `
                <div class="asr-code">${mp}</div>
            `).join(' ') || '<span style="color:var(--text-muted); font-size:0.8rem;">Aucun</span>';


            // Update ASR (activate based on CCC/MP)
            const allActivatedMPs = new Set([...activatedMPs, ...activatedCCC.map(c => c.micro_parcours)]);

            if (Array.isArray(DATA.asr)) {
                DATA.asr.forEach(asr => {
                    const code = asr.code || "Unknown";
                    const el = document.getElementById(`asr-${code}`);
                    if (el) el.classList.toggle('activated', allActivatedMPs.has(code));
                });
            } else if (DATA.asr) {
                Object.entries(DATA.asr).forEach(([code, val]) => {
                    const el = document.getElementById(`asr-${code}`);
                    if (el) el.classList.toggle('activated', allActivatedMPs.has(code));
                });
            }

            // Update scoring details
            document.getElementById('scoring-details').innerHTML = Object.entries(answers).map(([qId, ans]) => {
                if (ans.score === 0) return '';
                return `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg); border-radius: 0.25rem; margin-bottom: 0.25rem; font-size: 0.85rem;">
                        <span>${qId}</span>
                        <span style="color: var(--primary);">${ans.score}</span>
                    </div>
                `;
            }).join('');

            // Update recommendations
            const recos = getRecommendations(hasCritical, priorityClass);
            renderRecommendationsList(recos);
            renderMicroTasks(recos);
        }

        function cleanText(t) {
            return t ? t.toLowerCase().replace(/['"¬´¬ª]/g, '').trim() : "";
        }

        function getRecommendations(hasCritical, priorityClass) {
            let recos = [];
            if (DATA.recommendations) {
                Object.entries(answers).forEach(([qId, ans]) => {
                    const optionCode = ans.optionCode;
                    const questionRecos = DATA.recommendations[qId];
                    if (questionRecos && questionRecos[optionCode]) {
                        const reco = questionRecos[optionCode];
                        if (reco.app_text || (reco.micro_tasks && reco.micro_tasks.length > 0)) {
                            let thisPriority = 'planifie';
                            const isCrit = DATA.triggers?.critical_direct?.some(t => t.question_id === qId && t.option === optionCode);
                            if (isCrit) thisPriority = 'urgent';
                            else {
                                const isStd = DATA.triggers?.standard?.some(t => t.question_id === qId && t.option === optionCode);
                                if (isStd) thisPriority = 'prioritaire';
                                else if (priorityClass === 'level-1') thisPriority = 'urgent';
                            }

                            recos.push({
                                id: `RECO-${qId}-${optionCode}`,
                                question_id: qId,
                                priority: thisPriority,
                                title: `${qId} - Recommandation`,
                                app_text: reco.app_text,
                                actors: reco.actors || [],
                                micro_tasks: reco.micro_tasks?.map(mt => mt.text || mt) || []
                            });
                        }
                    }
                });
            }
            return recos;
        }

        function renderRecommendationsList(recos) {
            const container = document.getElementById('reco-list');
            if (recos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üí°</div>
                        <p>R√©pondez aux questions pour voir les recommandations</p>
                    </div>
                `;
                return;
            }

            const priorityOrder = { 'urgent': 1, 'prioritaire': 2, 'planifie': 3 };
            recos.sort((a, b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));

            container.innerHTML = recos.map(reco => `
                <div class="reco-item ${reco.priority}">
                    <div class="reco-header">
                        <span class="reco-priority ${reco.priority}">${reco.priority.toUpperCase()}</span>
                        <span style="font-weight: 600; font-size: 0.85rem;">${reco.title}</span>
                    </div>
                    ${reco.app_text ? `<div class="reco-text">üì± ${reco.app_text}</div>` : ''}
                </div>
            `).join('');
        }

        function renderMicroTasks(recos) {
            const container = document.getElementById('mt-list');
            let allTasks = [];
            recos.forEach(r => {
                if (r.micro_tasks) {
                    r.micro_tasks.forEach(mt => {
                        const txt = typeof mt === 'string' ? mt : mt.text;
                        allTasks.push({ text: txt, origin: r.title, priority: r.priority });
                    });
                }
            });

            if (allTasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Aucune micro-t√¢che</p></div>';
                return;
            }

            container.innerHTML = allTasks.map(t => `
                 <div class="micro-task" style="padding:0.5rem; background:rgba(255,255,255,0.05); margin-bottom:0.25rem; border-radius:0.25rem; border-left: 3px solid var(--text-muted);">
                    <div style="display:flex; align-items:center;">
                        <span style="font-size:0.8rem; margin-right:0.5rem;">${t.priority === 'urgent' ? 'üî¥' : t.priority === 'prioritaire' ? 'üü†' : 'üîµ'}</span>
                        <span style="font-size:0.9rem;">${t.text}</span>
                    </div>
                    <div style="font-size:0.7rem; color:var(--text-muted); margin-left: 1.5rem;">Src: ${t.origin}</div>
                 </div>
            `).join('');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`.tab-content#tab-${tabId}`)?.classList.add('active');

            // Robust button activation
            document.querySelectorAll('.tab').forEach(t => {
                const onclick = t.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabId}'`)) {
                    t.classList.add('active');
                }
            });
        }

        function resetAll() {
            answers = {};
            document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('active'));
            document.getElementById('persona-info').classList.remove('visible');
            renderQuestions();
            updateResults();
        }

        // Initialize with V1
        loadVulnerability('V1');
    </script>
</body>

</html>