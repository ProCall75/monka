"use client";

import React, { useState, useEffect } from 'react';
import { ThemeButton } from '../atoms/ThemeButton';
import { MProgressDots } from '../atoms/MProgressDots';
import { MTag } from '../atoms/MTag';
import { Clock, ChatDots } from '@phosphor-icons/react';
import type { VulnerabilityDomain } from '../../data/kernel-types';
import { ThemeColors } from '../../data/kernel-types';

export interface VulnerabilityIntroCardProps {
    domain: VulnerabilityDomain;
    title: string;
    description: string;
    questionCount: number;
    estimatedMinutes: number;
    currentStep?: number;
    totalSteps?: number;
    onStart?: () => void;
}

const DOMAIN_LABELS: Record<VulnerabilityDomain, string> = {
    R: 'Vie sociale',
    A: 'Démarches',
    S: 'Santé',
    F: 'Votre proche',
    M: 'Parcours de soins',
};

export const VulnerabilityIntroCard = ({
    domain,
    title,
    description,
    questionCount,
    estimatedMinutes,
    currentStep = 0,
    totalSteps = 5,
    onStart,
}: VulnerabilityIntroCardProps) => {
    const [phase, setPhase] = useState(0); // 0=hidden, 1=icon, 2=text, 3=meta, 4=ready
    const colors = ThemeColors[domain];

    useEffect(() => {
        const timers = [
            setTimeout(() => setPhase(1), 150),
            setTimeout(() => setPhase(2), 450),
            setTimeout(() => setPhase(3), 700),
            setTimeout(() => setPhase(4), 950),
        ];
        return () => timers.forEach(clearTimeout);
    }, []);

    return (
        <div
            className="rounded-[28px] overflow-hidden relative"
            style={{
                background: '#FAFAF8',
                border: '1px solid #EDE8E1',
                boxShadow: '0 4px 24px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02)',
                fontFamily: "'Outfit', 'Inter', sans-serif",
            }}
        >
            {/* Subtle top gradient accent */}
            <div
                className="absolute top-0 left-0 right-0 h-[3px] rounded-t-[28px]"
                style={{
                    background: `linear-gradient(90deg, ${colors.color}40 0%, ${colors.color} 50%, ${colors.color}40 100%)`,
                    opacity: phase >= 1 ? 1 : 0,
                    transition: 'opacity 0.6s ease-out',
                }}
            />

            <div className="flex flex-col items-center text-center px-8 pt-12 pb-8">
                {/* Theme icon — bounce in */}
                <div
                    className="mb-5"
                    style={{
                        transform: phase >= 1 ? 'scale(1) translateY(0)' : 'scale(0.4) translateY(16px)',
                        opacity: phase >= 1 ? 1 : 0,
                        transition: 'all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)',
                    }}
                >
                    <ThemeButton domain={domain} size="lg" />
                </div>

                {/* Tag — wider, more visible */}
                <div
                    className="mb-3"
                    style={{
                        opacity: phase >= 2 ? 1 : 0,
                        transform: phase >= 2 ? 'translateY(0) scale(1)' : 'translateY(6px) scale(0.95)',
                        transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    }}
                >
                    <MTag label={DOMAIN_LABELS[domain] ?? domain} domain={domain} size="md" />
                </div>

                {/* Title */}
                <h2
                    className="text-[22px] font-bold text-[#2D2A26] mb-2 leading-tight"
                    style={{
                        opacity: phase >= 2 ? 1 : 0,
                        transform: phase >= 2 ? 'translateY(0)' : 'translateY(8px)',
                        transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.08s',
                    }}
                >
                    {title}
                </h2>

                {/* Description */}
                <p
                    className="text-[14px] text-[#8A857E] leading-relaxed max-w-[280px] mb-7"
                    style={{
                        opacity: phase >= 2 ? 1 : 0,
                        transform: phase >= 2 ? 'translateY(0)' : 'translateY(8px)',
                        transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.16s',
                    }}
                >
                    {description}
                </p>

                {/* Meta badges */}
                <div
                    className="flex items-center gap-3 mb-8"
                    style={{
                        opacity: phase >= 3 ? 1 : 0,
                        transform: phase >= 3 ? 'translateY(0)' : 'translateY(6px)',
                        transition: 'all 0.35s ease-out',
                    }}
                >
                    <div
                        className="flex items-center gap-1.5 px-3 py-1.5 rounded-full"
                        style={{ backgroundColor: `${colors.color}0A` }}
                    >
                        <ChatDots size={14} weight="fill" style={{ color: colors.color, opacity: 0.7 }} />
                        <span className="text-[12px] font-semibold" style={{ color: colors.color }}>
                            {questionCount} questions
                        </span>
                    </div>
                    <div
                        className="flex items-center gap-1.5 px-3 py-1.5 rounded-full"
                        style={{ backgroundColor: '#2D2A260A' }}
                    >
                        <Clock size={14} weight="fill" className="text-[#8A857E] opacity-70" />
                        <span className="text-[12px] font-semibold text-[#8A857E]">
                            ~{estimatedMinutes} min
                        </span>
                    </div>
                </div>

                {/* Progress dots */}
                <div
                    className="w-full max-w-[160px] mb-7"
                    style={{
                        opacity: phase >= 3 ? 1 : 0,
                        transition: 'opacity 0.3s ease-out 0.1s',
                    }}
                >
                    <MProgressDots total={totalSteps} current={currentStep} accentColor={colors.color} />
                </div>

                {/* CTA — gradient with domain hint */}
                <button
                    onClick={onStart}
                    className="w-full py-4 rounded-[16px] text-[15px] font-bold text-white transition-all duration-200 active:scale-[0.97]"
                    style={{
                        background: `linear-gradient(135deg, #2D2A26 0%, #1A1714 100%)`,
                        boxShadow: `0 4px 16px rgba(45,42,38,0.2), 0 0 0 1px rgba(45,42,38,0.05)`,
                        opacity: phase >= 4 ? 1 : 0,
                        transform: phase >= 4 ? 'translateY(0)' : 'translateY(8px)',
                        transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    }}
                >
                    Commencer
                </button>
            </div>
        </div>
    );
};
