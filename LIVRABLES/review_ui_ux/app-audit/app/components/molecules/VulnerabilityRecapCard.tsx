"use client";

import React, { useState, useEffect } from 'react';
import { ThemeButton } from '../atoms/ThemeButton';
import { ScoreRing } from '../atoms/ScoreRing';
import { ArrowRight, Sparkle } from '@phosphor-icons/react';
import type { VulnerabilityDomain } from '../../data/kernel-types';
import { ThemeColors } from '../../data/kernel-types';

export interface ActivatedMPItem {
    id: string;
    name: string;
    level: 'critical' | 'ccc' | 'standard' | 'prevention';
    taskCount: number;
}

export interface VulnerabilityRecapCardProps {
    domain: VulnerabilityDomain;
    title: string;
    score: number;
    activatedMPs: ActivatedMPItem[];
    onContinue?: () => void;
    continueLabel?: string;
}

const LEVEL_STYLES: Record<string, { dot: string; border: string; label: string; bg: string }> = {
    critical: { dot: '#EF4444', border: '#FEE2E2', label: 'Urgent', bg: '#FEF2F2' },
    ccc: { dot: '#F59E0B', border: '#FEF3C7', label: 'Important', bg: '#FFFBEB' },
    standard: { dot: '#10B981', border: '#D1FAE5', label: 'Standard', bg: '#ECFDF5' },
    prevention: { dot: '#8B5CF6', border: '#EDE9FE', label: 'Prévention', bg: '#F5F3FF' },
};

export const VulnerabilityRecapCard = ({
    domain,
    title,
    score,
    activatedMPs,
    onContinue,
    continueLabel = 'Thème suivant →',
}: VulnerabilityRecapCardProps) => {
    const [animScore, setAnimScore] = useState(0);
    const [showMPs, setShowMPs] = useState(false);
    const [showCTA, setShowCTA] = useState(false);
    const colors = ThemeColors[domain];

    useEffect(() => {
        // Smooth score count-up with easing
        const start = Date.now();
        const duration = 1200;
        const animate = () => {
            const elapsed = Date.now() - start;
            const progress = Math.min(elapsed / duration, 1);
            // Ease-out cubic
            const eased = 1 - Math.pow(1 - progress, 3);
            setAnimScore(Math.round(score * eased));
            if (progress < 1) requestAnimationFrame(animate);
        };
        requestAnimationFrame(animate);

        const t1 = setTimeout(() => setShowMPs(true), 900);
        const t2 = setTimeout(() => setShowCTA(true), 900 + activatedMPs.length * 120 + 200);
        return () => { clearTimeout(t1); clearTimeout(t2); };
    }, [score, activatedMPs.length]);

    return (
        <div
            className="rounded-[28px] overflow-hidden relative"
            style={{
                background: '#FAFAF8',
                border: '1px solid #EDE8E1',
                boxShadow: '0 4px 24px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02)',
                fontFamily: "'Outfit', 'Inter', sans-serif",
            }}
        >
            {/* Success accent bar */}
            <div
                className="absolute top-0 left-0 right-0 h-[3px] rounded-t-[28px]"
                style={{
                    background: `linear-gradient(90deg, #10B981 0%, ${colors.color} 100%)`,
                }}
            />

            <div className="flex flex-col items-center text-center px-6 pt-8 pb-6">
                {/* Completion badge */}
                <div
                    className="flex items-center gap-2 mb-5 px-4 py-2 rounded-full"
                    style={{
                        backgroundColor: '#ECFDF5',
                        animation: 'vrc-fadeDown 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    }}
                >
                    <Sparkle size={16} weight="fill" className="text-[#10B981]" />
                    <span className="text-[13px] font-bold text-[#10B981]">
                        Thème complété
                    </span>
                </div>

                {/* Theme + title */}
                <div className="flex items-center gap-2.5 mb-6">
                    <ThemeButton domain={domain} size="sm" />
                    <h2 className="text-[18px] font-bold text-[#2D2A26]">{title}</h2>
                </div>

                {/* Score ring with domain color */}
                <div
                    className="mb-7 relative"
                    style={{ animation: 'vrc-scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both' }}
                >
                    <ScoreRing score={animScore} size={130} color={colors.color} label="Score vulnérabilité" />
                </div>

                {/* Activated MPs */}
                {showMPs && (
                    <div className="w-full space-y-2.5 mb-6">
                        <p className="text-[11px] font-bold text-[#B8B3AB] uppercase tracking-[0.1em] text-left mb-3">
                            Parcours débloqués
                        </p>
                        {activatedMPs.map((mp, i) => {
                            const style = LEVEL_STYLES[mp.level];
                            return (
                                <button
                                    key={mp.id}
                                    className="w-full flex items-center gap-3 rounded-[16px] px-4 py-3.5 text-left transition-all duration-200 hover:shadow-sm active:scale-[0.98]"
                                    style={{
                                        backgroundColor: style.bg,
                                        border: `1.5px solid ${style.border}`,
                                        animation: `vrc-slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) ${i * 0.1}s both`,
                                    }}
                                >
                                    {/* Level dot */}
                                    <div
                                        className="w-[10px] h-[10px] rounded-full flex-shrink-0"
                                        style={{
                                            backgroundColor: style.dot,
                                            boxShadow: `0 0 0 3px ${style.dot}20`,
                                        }}
                                    />
                                    <div className="flex-1 min-w-0">
                                        <p className="text-[13px] font-semibold text-[#2D2A26]">
                                            {mp.name}
                                            <span className="text-[#B8B3AB] font-normal ml-1.5 text-[12px]">{mp.id}</span>
                                        </p>
                                        <p className="text-[11px] text-[#8A857E] mt-0.5">
                                            {mp.taskCount} action{mp.taskCount > 1 ? 's' : ''} · {style.label}
                                        </p>
                                    </div>
                                    <ArrowRight size={14} weight="bold" className="text-[#B8B3AB] flex-shrink-0" />
                                </button>
                            );
                        })}
                    </div>
                )}

                {/* CTA */}
                {showCTA && (
                    <button
                        onClick={onContinue}
                        className="w-full py-4 rounded-[16px] text-[15px] font-bold text-white transition-all duration-200 active:scale-[0.97]"
                        style={{
                            background: 'linear-gradient(135deg, #2D2A26 0%, #1A1714 100%)',
                            boxShadow: '0 4px 16px rgba(45,42,38,0.2)',
                            animation: 'vrc-fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        }}
                    >
                        {continueLabel}
                    </button>
                )}
            </div>

            <style jsx>{`
                @keyframes vrc-fadeDown {
                    from { opacity: 0; transform: translateY(-8px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes vrc-scaleIn {
                    from { opacity: 0; transform: scale(0.8); }
                    to { opacity: 1; transform: scale(1); }
                }
                @keyframes vrc-slideUp {
                    from { opacity: 0; transform: translateY(12px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes vrc-fadeUp {
                    from { opacity: 0; transform: translateY(8px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `}</style>
        </div>
    );
};
