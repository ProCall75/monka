<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Monka Simulator ‚Äì Vuln√©rabilit√© Sociale & Relationnelle</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            border-radius: 1rem;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        header p {
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .panel-title .icon {
            font-size: 1.5rem;
        }

        /* Questionnaire */
        .question-card {
            background: var(--bg);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .question-card:hover {
            border-color: var(--primary);
        }

        .question-card.critical {
            border-left: 4px solid var(--danger);
        }

        .question-card.scoring {
            border-left: 4px solid var(--primary);
        }

        .question-card.trigger {
            border-left: 4px solid var(--warning);
        }

        .question-id {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .question-id.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .question-id.scoring {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .question-id.trigger {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .question-label {
            font-weight: 500;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .option:hover {
            background: var(--bg-hover);
        }

        .option.selected {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
        }

        .option.critical-selected {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
        }

        .option input {
            display: none;
        }

        .option .radio {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .option.selected .radio {
            border-color: var(--primary);
            background: var(--primary);
        }

        .option.critical-selected .radio {
            border-color: var(--danger);
            background: var(--danger);
        }

        .option .radio::after {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .option.selected .radio::after,
        .option.critical-selected .radio::after {
            opacity: 1;
        }

        .option-score {
            margin-left: auto;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background: var(--bg);
        }

        /* Results Panel */
        .result-section {
            margin-bottom: 1.5rem;
        }

        .result-section h4 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: var(--bg);
            border-radius: 0.75rem;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            border: 4px solid;
            transition: all 0.3s ease;
        }

        .score-circle.green {
            border-color: var(--success);
            color: var(--success);
        }

        .score-circle.orange {
            border-color: var(--warning);
            color: var(--warning);
        }

        .score-circle.red {
            border-color: var(--danger);
            color: var(--danger);
        }

        .score-details {
            flex: 1;
        }

        .score-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .score-interpretation {
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .priority-badge.level-1 {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .priority-badge.level-2 {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .priority-badge.level-3 {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .micro-parcours-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .micro-parcours {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg);
            border-radius: 0.5rem;
            border-left: 3px solid var(--primary);
        }

        .micro-parcours.activated {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .mp-code {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .ccc-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ccc-item {
            padding: 0.75rem 1rem;
            background: var(--bg);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ccc-item.activated {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--danger);
        }

        .ccc-status {
            font-size: 1.25rem;
        }

        /* Recommendations Panel */
        .reco-card {
            background: var(--bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--primary);
        }

        .reco-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .reco-question-id {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--primary);
        }

        .reco-actor {
            margin-left: auto;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 0.25rem;
            color: var(--primary);
        }

        .reco-text {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .micro-tasks {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .micro-task {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.825rem;
            color: var(--text-muted);
        }

        .micro-task::before {
            content: '‚Üí';
            color: var(--success);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .tab:hover {
            background: var(--bg-hover);
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Action buttons */
        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--bg-hover);
        }

        /* Scrollable panels */
        .scrollable {
            max-height: 70vh;
            overflow-y: auto;
        }

        .scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 3px;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Micro-Task Type Badges */
        .mt-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 60px;
            text-align: center;
        }

        .mt-struc {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .mt-sec {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .mt-med {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .mt-info {
            background: rgba(6, 182, 212, 0.2);
            color: #22d3ee;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .mt-orga {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .microtask-item {
            background: var(--bg);
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid var(--border);
        }

        .microtask-text {
            flex: 1;
            font-size: 0.875rem;
        }

        /* Animation */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Tab Badges */
        .tab-badge {
            margin-left: 6px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .tab-badge-externe {
            background: #10b981;
            color: white;
        }

        .tab-badge-interne {
            background: #3b82f6;
            color: white;
        }

        .tab-badge-doc {
            background: #6b7280;
            color: white;
        }

        /* Priority Badges */
        .priority-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .priority-badge.level-1 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .priority-badge.level-2 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .priority-badge.level-3 {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }

        /* Justificatif Tab Styles */
        .justif-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .justif-section h4 {
            color: #a78bfa;
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .rule-item {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .rule-item.active {
            background: rgba(16, 185, 129, 0.15);
            border-left-color: #10b981;
        }

        /* Decision Tree Styles */
        .decision-tree-container {
            margin-top: 1.5rem;
        }

        .decision-question {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .question-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .question-id-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .question-text {
            flex: 1;
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .decision-flow {
            margin-left: 1.5rem;
            padding-left: 1.5rem;
            border-left: 3px solid var(--border);
            margin-top: 1rem;
        }

        .answer-branch {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .answer-branch::before {
            content: '‚îú‚îÄ‚Üí';
            position: absolute;
            left: -2.5rem;
            top: 0.5rem;
            color: var(--text-muted);
            font-family: monospace;
            font-size: 1rem;
        }

        .answer-branch:last-child::before {
            content: '‚îî‚îÄ‚Üí';
        }

        .answer-node {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .answer-node.critical {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        .answer-badge {
            background: #059669;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .answer-badge.critical {
            background: #dc2626;
        }

        .answer-text {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 500;
            color: #065f46;
        }

        .answer-node.critical .answer-text {
            color: #991b1b;
        }

        .triggers-container {
            margin-left: 2rem;
            padding-left: 1.5rem;
            border-left: 2px dashed var(--border);
        }

        .trigger-block {
            margin-bottom: 1rem;
        }

        .recommendation-trigger {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            padding: 0.875rem;
            margin-bottom: 0.75rem;
        }

        .trigger-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .trigger-icon {
            font-size: 1.1rem;
        }

        .trigger-label {
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #6d28d9;
            letter-spacing: 0.5px;
        }

        .trigger-content {
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
            color: #5b21b6;
        }

        .trigger-why {
            background: rgba(255, 255, 255, 0.5);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            line-height: 1.4;
            font-style: italic;
            color: #4c1d95;
        }

        .trigger-why strong {
            font-style: normal;
            font-weight: 700;
        }

        .ccc-trigger {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            border: 3px solid #f59e0b;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .ccc-alert {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .ccc-icon {
            font-size: 1.25rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .ccc-label {
            font-weight: 800;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #92400e;
            letter-spacing: 0.5px;
        }

        .ccc-code {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            color: #b45309;
            margin-bottom: 0.25rem;
        }

        .ccc-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: #78350f;
            margin-bottom: 0.75rem;
        }

        .microtasks-block {
            background: rgba(224, 231, 255, 0.3);
            border-left: 3px solid #6366f1;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .microtasks-header {
            font-weight: 700;
            font-size: 0.75rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .microtasks-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mt-item-compact {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            padding: 0.375rem 0.5rem;
            background: var(--card-bg);
            border-radius: 4px;
        }

        .mt-item-compact .mt-badge {
            flex-shrink: 0;
        }

        .mt-item-compact .mt-text {
            flex: 1;
            line-height: 1.3;
        }

        .no-triggers {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-style: italic;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .tree-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 2rem 0 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rule-code {
            font-family: 'Courier New', monospace;
            color: #a78bfa;
            font-weight: 600;
        }

        .logic-tree {
            font-size: 13px;
            line-height: 1.8;
            color: #cbd5e1;
        }

        .logic-arrow {
            color: #8b5cf6;
            font-weight: bold;
            margin: 0 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üß™ Monka Simulator</h1>
            <p>Test interactif ‚Äì Vuln√©rabilit√© "Sociale & Relationnelle"</p>
        </header>

        <div class="grid">
            <!-- LEFT: Questionnaire -->
            <div class="panel">
                <div class="panel-title">
                    <span class="icon">üìã</span>
                    <span>Questionnaire Aidant</span>
                </div>

                <!-- Persona Selector -->
                <div
                    style="background: var(--card-bg); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 2px solid #8b5cf6;">
                    <h4
                        style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: #8b5cf6; display: flex; align-items: center; gap: 0.5rem;">
                        üé≠ Tester avec un Persona
                        <button onclick="resetAll()"
                            style="margin-left: auto; padding: 4px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; cursor: pointer; color: var(--text);">
                            üîÑ R√©initialiser
                        </button>
                    </h4>

                    <div id="persona-grid"
                        style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                        <!-- Persona cards will be injected here -->
                    </div>

                    <div id="persona-info"
                        style="padding: 0.75rem; background: var(--bg); border-radius: 8px; font-size: 0.8125rem; display: none;">
                        <!-- Active persona description -->
                    </div>
                </div>

                <div class="scrollable" id="questionnaire">
                    <!-- Questions will be injected here -->
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="resetAll()">üîÑ R√©initialiser</button>
                </div>
            </div>

            <!-- RIGHT: Results -->
            <div class="panel">
                <div class="panel-title">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Moteur Monka (Vue interne)</span>
                </div>

                <!-- Tab Navigation: External vs Internal -->
                <div style="border-bottom: 1px solid var(--border); margin-bottom: 1.5rem;">
                    <!-- External Section -->
                    <div style="padding: 0.5rem 0; border-bottom: 2px solid #10b981;">
                        <div
                            style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; margin-bottom: 0.5rem; padding: 0 0.25rem;">
                            üë§ VUE EXTERNE (Visible Aidant)
                        </div>
                        <div class="tabs" style="gap: 0.5rem;">
                            <div class="tab" onclick="switchTab('recos')">üí° Recommandations</div>
                        </div>
                    </div>

                    <!-- Internal Section -->
                    <div style="padding: 0.5rem 0; margin-top: 1rem; border-bottom: 2px solid #3b82f6;">
                        <div
                            style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #3b82f6; margin-bottom: 0.5rem; padding: 0 0.25rem;">
                            üè• VUE INTERNE (IDEC Professionnel)
                        </div>
                        <div class="tabs" style="gap: 0.5rem;">
                            <div class="tab active" onclick="switchTab('scoring')">üìä Scoring</div>
                            <div class="tab" onclick="switchTab('engine')">üîß Moteur</div>
                            <div class="tab" onclick="switchTab('microtasks')">üè∑Ô∏è Micro-T√¢ches</div>
                            <div class="tab" onclick="switchTab('justificatif-dynamic')">üìã Justificatif</div>
                            <div class="tab" onclick="switchTab('regles')">üìú R√®gles</div>
                        </div>
                    </div>
                </div>

                <div class="scrollable">
                    <!-- Scoring Tab -->
                    <div class="tab-content active" id="tab-scoring">
                        <div class="result-section">
                            <h4>Score Vuln√©rabilit√©</h4>
                            <div class="score-display">
                                <div class="score-circle green" id="score-circle">
                                    <span id="score-value">0</span>
                                </div>
                                <div class="score-details">
                                    <div class="score-label">Score brut: <span id="score-raw">0</span>/16</div>
                                    <div class="score-interpretation" id="score-interpretation">Situation sociale
                                        globalement pr√©serv√©e</div>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Priorit√© calcul√©e</h4>
                            <div id="priority-display">
                                <div class="priority-badge level-3">
                                    <span>‚è±Ô∏è</span>
                                    <span>Niveau 3 ‚Äì Planifi√© (>1 mois)</span>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>D√©tail scoring par question</h4>
                            <div id="scoring-details">
                                <!-- Injected -->
                            </div>
                        </div>
                    </div>

                    <!-- Engine Tab -->
                    <div class="tab-content" id="tab-engine">
                        <div class="result-section">
                            <h4>Questions Critiques Directes</h4>
                            <div id="critical-list">
                                <div class="empty-state">
                                    <div class="icon">‚úÖ</div>
                                    <p>Aucune alerte critique</p>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Conditions Critiques Composites (CCC)</h4>
                            <div class="ccc-list" id="ccc-list">
                                <!-- Injected -->
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Micro-parcours activ√©s</h4>
                            <div class="micro-parcours-list" id="mp-list">
                                <!-- Injected -->
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations Tab -->
                    <div class="tab-content" id="tab-recos">
                        <div id="reco-list">
                            <div class="empty-state">
                                <div class="icon">üí°</div>
                                <p>R√©pondez aux questions pour voir les recommandations</p>
                            </div>
                        </div>
                    </div>

                    <!-- Micro-T√¢ches Tab -->
                    <div class="tab-content" id="tab-microtasks">
                        <div class="result-section">
                            <h4>Statistiques Typologie</h4>
                            <div
                                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                                <div
                                    style="background: var(--bg); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #10b981;">14</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">STRUC + SEC</div>
                                    <div style="font-size: 0.7rem; margin-top: 0.25rem;">‚úÖ Contributives ASR</div>
                                </div>
                                <div
                                    style="background: var(--bg); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #ef4444;">27</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">INFO + ORGA</div>
                                    <div style="font-size: 0.7rem; margin-top: 0.25rem;">‚ùå Non-contributives</div>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Distribution par Type</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="mt-badge mt-struc">STRUC</span>
                                    <div
                                        style="flex: 1; background: var(--bg); height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 10%; height: 100%; background: #8b5cf6;"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">4 (10%)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="mt-badge mt-sec">SEC</span>
                                    <div
                                        style="flex: 1; background: var(--bg); height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 25%; height: 100%; background: #10b981;"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">10 (25%)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="mt-badge mt-info">INFO</span>
                                    <div
                                        style="flex: 1; background: var(--bg); height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 30%; height: 100%; background: #06b6d4;"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">12 (30%)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="mt-badge mt-orga">ORGA</span>
                                    <div
                                        style="flex: 1; background: var(--bg); height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 37.5%; height: 100%; background: #f59e0b;"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">15 (37.5%)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="mt-badge mt-med">MED</span>
                                    <div
                                        style="flex: 1; background: var(--bg); height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 0%; height: 100%; background: #ef4444;"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">0 (0%)</span>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Toutes les Micro-T√¢ches (41)</h4>
                            <div id="microtask-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- JUSTIFICATIF DYNAMIQUE Tab -->
                    <div class="tab-content" id="tab-justificatif-dynamic">
                        <div class="justif-section">
                            <h4>üìä Vue d'ensemble</h4>
                            <div id="justif-summary"
                                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <!-- Summary stats will be injected here -->
                            </div>
                        </div>

                        <div class="justif-section">
                            <h4>üå≥ Arbre de D√©cision Clinique</h4>
                            <div id="decision-tree-container" class="decision-tree-container">
                                <p style="color: var(--text-muted); font-size: 0.875rem; font-style: italic;">
                                    R√©pondez aux questions pour voir l'arbre de d√©cision complet.
                                </p>
                            </div>
                        </div>

                        <div class="justif-section">
                            <h4>‚ö° Conditions Cliniques Composites Activ√©es</h4>
                            <div id="justif-ccc-detail">
                                <p style="color: var(--text-muted); font-size: 0.875rem; font-style: italic;">
                                    Aucune CCC activ√©e pour le moment.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- R√®gles Tab (Static Documentation) -->
                    <div class="tab-content" id="tab-regles">
                        <div class="justif-section">
                            <h4>üìú R√®gles Cliniques Appliqu√©es</h4>
                            <div id="justif-rules">
                                <div class="rule-item active">
                                    <span class="rule-code">R-MT-ASR-01</span> ‚Ä¢ S√©paration stricte micro-t√¢ches
                                    (moyens) / ASR (√©tats observ√©s)
                                </div>
                                <div class="rule-item active">
                                    <span class="rule-code">R-TEMP-01</span> ‚Ä¢ Priorisation temporelle : Critique (‚â§7j)
                                    ‚Üí CCC (‚â§1 mois) ‚Üí Standard (>1 mois)
                                </div>
                                <div class="rule-item active">
                                    <span class="rule-code">R-TYPE-01</span> ‚Ä¢ Typologie micro-t√¢ches : STRUC/SEC/MED
                                    contributives ASR, INFO/ORGA non contributives
                                </div>
                                <div class="rule-item">
                                    <span class="rule-code">R-CCC-01</span> ‚Ä¢ Activation CCC par combinaison structur√©e
                                    de signaux faibles
                                </div>
                            </div>
                        </div>

                        <div class="justif-section">
                            <h4>üéØ Logique de S√©lection des Recommandations</h4>
                            <div id="justif-reco-logic" class="logic-tree">
                                <p>Les recommandations sont g√©n√©r√©es selon un arbre d√©cisionnel :</p>
                                <ul>
                                    <li><strong>Niveau 1 (üö® URGENT)</strong> : R√©ponses critiques directes d√©tect√©es
                                    </li>
                                    <li><strong>Niveau 2 (‚ö° PRIORITAIRE)</strong> : Conditions Cliniques Composites
                                        (CCC) activ√©es</li>
                                    <li><strong>Niveau 3 (‚è±Ô∏è PLANIFI√â)</strong> : Score de vuln√©rabilit√© standard</li>
                                </ul>
                                <p style="margin-top: 12px; font-size: 12px; color: #94a3b8;">
                                    üìä Chaque r√©ponse d√©clenche des micro-t√¢ches typ√©es. Seules les STRUC/SEC/MED
                                    contribuent aux ASR.
                                </p>
                            </div>
                        </div>

                        <div class="justif-section">
                            <h4>üîß D√©clenchement des CCC</h4>
                            <div id="justif-ccc-logic" class="logic-tree">
                                <p>Les CCC sont activ√©es par combinaison de signaux :</p>
                                <div id="ccc-trigger-list">
                                    <!-- Populated dynamically with active CCCs -->
                                    <p style="color: #94a3b8; font-style: italic;">R√©pondez aux questions pour voir les
                                        CCC activ√©es</p>
                                </div>
                            </div>
                        </div>

                        <div class="justif-section">
                            <h4>üè∑Ô∏è Typologie des Micro-T√¢ches</h4>
                            <div class="logic-tree">
                                <p><span class="mt-badge mt-struc">STRUC</span> <span class="logic-arrow">‚Üí</span>
                                    Structuration environnement (contributive ASR)</p>
                                <p><span class="mt-badge mt-sec">SEC</span> <span class="logic-arrow">‚Üí</span>
                                    S√©curisation dyade (contributive ASR)</p>
                                <p><span class="mt-badge mt-med">MED</span> <span class="logic-arrow">‚Üí</span> M√©diation
                                    relationnelle (contributive ASR)</p>
                                <p><span class="mt-badge mt-info">INFO</span> <span class="logic-arrow">‚Üí</span>
                                    Information/orientation (non contributive)</p>
                                <p><span class="mt-badge mt-orga">ORGA</span> <span class="logic-arrow">‚Üí</span>
                                    Organisation/diagnostic (non contributive)</p>
                            </div>
                        </div>

                        <div class="justif-section">
                            <h4>üë§ Distinction Externe / Interne</h4>
                            <div class="logic-tree">
                                <p><span class="tab-badge tab-badge-externe">üë§ EXTERNE</span> <span
                                        class="logic-arrow">‚Üí</span> Visible par l'aidant (uniquement Recommandations)
                                </p>
                                <p><span class="tab-badge tab-badge-interne">üè• INTERNE</span> <span
                                        class="logic-arrow">‚Üí</span> R√©serv√© aux IDEC (Scoring, Moteur, Micro-Parcours,
                                    Micro-T√¢ches)</p>
                                <p><span class="tab-badge tab-badge-doc">üìã DOC</span> <span
                                        class="logic-arrow">‚Üí</span> Documentation technique (cet onglet)</p>
                                <p style="margin-top: 12px; font-size: 12px; color: #94a3b8;">
                                    Cette s√©paration garantit que l'aidant re√ßoit uniquement des recommandations
                                    actionnables,
                                    tandis que l'IDEC dispose de tous les √©l√©ments de diagnostic et d'analyse.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Personas for testing and demos
        const personas = [
            {
                id: 'persona1',
                name: 'Marie D., 58 ans',
                emoji: 'üë©‚Äçü¶≥',
                situation: 'Fille unique, aidante principale pour sa m√®re (Alzheimer d√©butant). Travaille √† temps partiel, tensions familiales.',
                profile: { charge: 'exclusive', soutien: 'faible', impactVie: '√©lev√©', relationTendue: true },
                answers: {
                    'E1': 2, 'E2': 2, 'E4': 1, 'E5': 1, 'E6': 1,
                    'N4': 1, 'N20': 1, 'O27': 2, 'O28': 2, 'O30': 1
                },
                expectedPriority: 'üö® Urgent',
                expectedCCC: 2
            },
            {
                id: 'persona2',
                name: 'Jean-Pierre L., 72 ans',
                emoji: 'üë®‚Äçü¶≥',
                situation: '√âpoux aidant pour son conjoint (Parkinson avanc√©). Bonne entraide familiale, relation stable.',
                profile: { charge: 'partag√©e', soutien: 'moyen', impactVie: 'faible', relationTendue: false },
                answers: {
                    'E1': 1, 'E2': 1, 'E4': 0, 'E5': 0, 'E6': 1,
                    'N4': 0, 'N20': 0, 'O27': 1, 'O28': 0, 'O30': 0
                },
                expectedPriority: '‚è±Ô∏è Planifi√©',
                expectedCCC: 0
            },
            {
                id: 'persona3',
                name: 'Sophie M., 45 ans',
                emoji: 'üë©‚Äçüíº',
                situation: 'Travaille √† temps plein, aidante pour son p√®re (post-AVC). Impact fort sur vie professionnelle et familiale.',
                profile: { charge: 'mod√©r√©e', soutien: 'bon', impactVie: '√©lev√©', relationTendue: false },
                answers: {
                    'E1': 1, 'E2': 0, 'E4': 0, 'E5': 1, 'E6': 0,
                    'N4': 0, 'N20': 1, 'O27': 2, 'O28': 2, 'O30': 0
                },
                expectedPriority: '‚ö° Prioritaire',
                expectedCCC: 1
            },
            {
                id: 'persona4',
                name: 'Ahmed K., 38 ans',
                emoji: 'üë®‚Äç‚öïÔ∏è',
                situation: 'Fils unique, parent handicap√© refuse cat√©goriquement aide ext√©rieure. Isolement total, √©puisement professionnel.',
                profile: { charge: 'exclusive', soutien: 'inexistant', impactVie: 'tr√®s √©lev√©', relationTendue: true },
                answers: {
                    'E1': 2, 'E2': 2, 'E4': 1, 'E5': 2, 'E6': 2,
                    'N4': 1, 'N20': 2, 'O27': 2, 'O28': 2, 'O30': 2
                },
                expectedPriority: 'üö® Critique',
                expectedCCC: 4
            },
            {
                id: 'persona5',
                name: 'Nathalie P., 62 ans',
                emoji: 'üë©',
                situation: 'Situation √©quilibr√©e, bon r√©seau familial, aide professionnelle accept√©e. Aucune tension.',
                profile: { charge: '√©quilibr√©e', soutien: 'excellent', impactVie: 'nul', relationTendue: false },
                answers: {
                    'E1': 0, 'E2': 0, 'E4': 0, 'E5': 0, 'E6': 0,
                    'N4': 0, 'N20': 0, 'O27': 0, 'O28': 0, 'O30': 0
                },
                expectedPriority: '‚úÖ Sain',
                expectedCCC: 0
            }
        ];

        // Data
        const questions = [
            {
                id: 'E1',
                label: 'Comment d√©cririez-vous la r√©partition de l\'aide au sein de votre entourage ?',
                type: 'scoring',
                options: [
                    { text: 'R√©partition √©quilibr√©e et satisfaisante', score: 0, critical: false },
                    { text: 'Je fais la plus grande partie mais c\'est acceptable', score: 1, critical: false },
                    { text: 'Je fais presque tout / je suis totalement seul¬∑e', score: 2, critical: false }
                ],
                recommendations: {
                    1: { reco: 'Proposer un temps d\'√©change pour identifier des relais potentiels', actor: 'IDEC', tasks: ['Lister les personnes mobilisables', 'Explorer les freins √† une meilleure r√©partition'] },
                    2: { reco: 'Identifier et mobiliser des ressources d\'aide compl√©mentaires', actor: 'IDEC / Assistante sociale', tasks: ['√âvaluer les aides disponibles', 'Proposer un accompagnement pour solliciter de l\'aide', 'Orienter vers des groupes d\'entraide'] }
                }
            },
            {
                id: 'E2',
                label: 'En cas de coup dur, avez-vous des personnes sur qui compter pour vous aider ?',
                type: 'critical',
                options: [
                    { text: 'Oui, plusieurs personnes', score: 0, critical: false },
                    { text: 'Oui, une personne', score: 1, critical: false },
                    { text: 'Tr√®s peu de personnes / personne', score: 2, critical: true }
                ],
                recommendations: {
                    1: { reco: 'Renforcer le r√©seau de soutien existant', actor: 'IDEC', tasks: ['Identifier d\'autres personnes mobilisables', 'Informer sur les solutions de r√©pit'] },
                    2: { reco: 'Mettre en place un accompagnement renforc√© et identifier des solutions de soutien', actor: 'IDEC / Assistante sociale', tasks: ['√âvaluer l\'urgence de l\'isolement', 'Proposer un contact r√©gulier avec un professionnel', 'Orienter vers des dispositifs d\'aide aux aidants', 'Envisager un accueil temporaire'] }
                }
            },
            {
                id: 'E4',
                label: 'Comment a √©volu√© votre relation avec votre proche depuis que vous l\'aidez ?',
                type: 'scoring',
                options: [
                    { text: 'Relation renforc√©e ou globalement similaire', score: 0, critical: false },
                    { text: 'Relation plus tendue / plus compliqu√©e', score: 1, critical: false }
                ],
                recommendations: {
                    1: { reco: 'Proposer un espace d\'√©coute pour aborder les difficult√©s relationnelles', actor: 'IDEC / Psychologue', tasks: ['√âchanger sur les sources de tension', 'Proposer un accompagnement psychologique', 'Informer sur les groupes de parole'] }
                }
            },
            {
                id: 'E5',
                label: 'Existe-t-il des tensions ou des d√©saccords au sein de la famille concernant la prise en charge de votre proche ?',
                type: 'scoring',
                options: [
                    { text: 'Non', score: 0, critical: false },
                    { text: 'Parfois', score: 1, critical: false },
                    { text: 'Oui', score: 2, critical: false }
                ],
                recommendations: {
                    1: { reco: '√âchanger sur les sources de d√©saccord', actor: 'IDEC', tasks: ['Identifier les points de tension r√©currents'] },
                    2: { reco: 'Se rapprocher du r√©f√©rent, envisager une m√©diation familiale', actor: 'IDEC / M√©decin / M√©diateur', tasks: ['Proposer un entretien de m√©diation', 'Orienter vers des dispositifs de m√©diation'] }
                }
            },
            {
                id: 'E6',
                label: 'Votre proche accepte-t-il l\'aide de personnes ext√©rieures (aide √† domicile, infirmier, structure, etc.) ?',
                type: 'critical',
                options: [
                    { text: 'Oui, facilement', score: 0, critical: false },
                    { text: 'Oui, mais avec des r√©ticences', score: 0, critical: false },
                    { text: 'Non, refuse la plupart du temps', score: 0, critical: true },
                    { text: 'Je ne sais pas / pas encore essay√©', score: 0, critical: false }
                ],
                recommendations: {
                    1: { reco: '√âchanger sur les r√©ticences exprim√©es', actor: 'IDEC', tasks: ['Comprendre les freins √† l\'acceptation'] },
                    2: { reco: 'Accompagnement renforc√© pour lever les blocages', actor: 'IDEC / M√©decin', tasks: ['Proposer un √©change avec le proche', 'Explorer les causes du refus', 'Proposer une approche progressive'] },
                    3: { reco: 'Informer sur les types d\'aides existantes', actor: 'IDEC', tasks: ['Proposer une premi√®re mise en relation'] }
                }
            },
            {
                id: 'N4',
                label: '√ätes-vous le seul membre de la famille √† vous occuper de votre proche ?',
                type: 'trigger',
                options: [
                    { text: 'Non', score: 0, critical: false, trigger: null },
                    { text: 'Oui', score: 0, critical: false, trigger: 'R2' }
                ],
                recommendations: {
                    1: { reco: 'Identifier des relais possibles et s√©curiser l\'aidant principal', actor: 'IDEC', tasks: ['√âvaluer les possibilit√©s de mobilisation', 'Proposer des solutions de r√©pit', 'Orienter vers des associations'] }
                }
            },
            {
                id: 'N20',
                label: 'Votre proche a-t-il des difficult√©s √† maintenir des relations sociales ?',
                type: 'scoring',
                options: [
                    { text: 'Non', score: 0, critical: false },
                    { text: 'Parfois', score: 1, critical: false },
                    { text: 'Oui', score: 2, critical: false }
                ],
                recommendations: {
                    1: { reco: 'Surveiller l\'√©volution', actor: 'IDEC', tasks: ['Identifier les situations probl√©matiques'] },
                    2: { reco: '√âvaluer les besoins de stimulation sociale', actor: 'IDEC / Ergoth√©rapeute', tasks: ['Proposer des activit√©s adapt√©es', '√âvaluer l\'int√©r√™t d\'un accueil de jour'] }
                }
            },
            {
                id: 'O27',
                label: 'La situation de votre proche a-t-elle des r√©percussions sur votre vie familiale ?',
                type: 'scoring',
                options: [
                    { text: 'Pas du tout', score: 0, critical: false },
                    { text: 'Un peu', score: 1, critical: false },
                    { text: 'Oui', score: 2, critical: false }
                ],
                recommendations: {
                    1: { reco: 'Surveiller l\'√©volution et proposer un √©change si besoin', actor: 'IDEC', tasks: ['Rester attentif aux signaux de d√©gradation'] },
                    2: { reco: 'Mettre en place un accompagnement pour pr√©server l\'√©quilibre familial', actor: 'IDEC / Psychologue', tasks: ['Identifier les domaines impact√©s', 'Proposer un soutien psychologique', 'Orienter vers des solutions de r√©pit'] }
                }
            },
            {
                id: 'O28',
                label: 'La situation de votre proche a-t-elle des r√©percussions sur votre vie sociale, vos loisirs ou votre travail ?',
                type: 'scoring',
                options: [
                    { text: 'Pas du tout', score: 0, critical: false },
                    { text: 'Un peu', score: 1, critical: false },
                    { text: 'Oui', score: 2, critical: false }
                ],
                recommendations: {
                    1: { reco: 'Surveiller et proposer un √©change', actor: 'IDEC', tasks: ['Identifier les activit√©s impact√©es'] },
                    2: { reco: 'Mettre en place un accompagnement renforc√©', actor: 'IDEC / Assistante sociale', tasks: ['√âvaluer l\'impact professionnel', 'Informer sur les droits des aidants', 'Proposer des solutions d\'am√©nagement'] }
                }
            },
            {
                id: 'O30',
                label: 'Avez-vous le sentiment de ne plus reconna√Ætre votre proche ?',
                type: 'scoring',
                options: [
                    { text: 'Pas du tout', score: 0, critical: false },
                    { text: 'Un peu', score: 1, critical: false },
                    { text: 'Oui', score: 2, critical: false }
                ],
                recommendations: {
                    1: { reco: 'Proposer un espace d\'√©coute', actor: 'IDEC', tasks: ['√âchanger sur les changements observ√©s'] },
                    2: { reco: 'Accompagnement psychologique recommand√©', actor: 'IDEC / Psychologue', tasks: ['Proposer un soutien psychologique', 'Informer sur la maladie', 'Orienter vers des groupes de parole'] }
                }
            }
        ];

        const cccRules = [
            { code: 'R1_CC_01', questions: ['O27', 'O28'], logic: 'O27=2 ET O28=2', mp: 'R1', label: 'Retentissement vie priv√©e + sociale' },
            { code: 'R2_CC_01', questions: ['N4', 'E2'], logic: 'N4=1 ET E2=2', mp: 'R2', label: 'Aidant seul sans soutien' },
            { code: 'R2_CC_02', questions: ['E1', 'E2'], logic: 'E1=2 ET E2=2', mp: 'R2', label: 'Charge exclusive sans filet' },
            { code: 'R3_CC_01', questions: ['N20', 'O48'], logic: 'N20=2 ET O48‚â§1', mp: 'R3', label: 'Isolement social du proche' },
            { code: 'R4_CC_01', questions: ['O30', 'E4'], logic: 'O30=2 ET E4=1', mp: 'R4', label: 'D√©gradation du lien' },
            { code: 'R4_CC_02', questions: ['E5', 'E1'], logic: 'E5=2 ET E1=2', mp: 'R4', label: 'Conflits + charge d√©s√©quilibr√©e' }
        ];

        const microParcours = [
            { code: 'R1', name: 'Impact vie personnelle / sociale / pro' },
            { code: 'R2', name: 'Soutien de l\'entourage' },
            { code: 'R3', name: 'Isolement social du proche' },
            { code: 'R4', name: 'Relation aidant/aid√© & dynamique familiale' }
        ];

        const cccRecommendations = {
            'R1_CC_01': {
                code: 'R1_CC_01',
                name: 'Retentissement vie familiale + sociale/pro',
                condition: 'O27=Oui ET O28=Oui',
                reco: 'Organiser une r√©union de synth√®se pluridisciplinaire urgente pour sauver l\'√©quilibre global de l\'aidant et mettre en place un plan de soutien coordonn√©.',
                actor: 'IDEC (coordinateur) + Psychologue + Assistante sociale + M√©decin traitant',
                tasks: [
                    'Convoquer une r√©union de concertation sous 7 jours avec tous les acteurs',
                    'R√©aliser une cartographie exhaustive des impacts (famille, travail, loisirs, sant√©)',
                    'Co-construire un plan d\'action avec objectifs √† 1 mois',
                    'Mettre en place un suivi hebdomadaire pendant 1 mois',
                    '√âvaluer l\'√©ligibilit√© √† un cong√© de proche aidant'
                ]
            },
            'R1_CC_02': {
                code: 'R1_CC_02',
                name: 'Am√©nagement professionnel + retentissement familial',
                condition: 'N7=am√©nagement ET O27=Oui',
                reco: 'R√©√©valuer en urgence l\'organisation globale avec un accompagnement sur les droits des aidants et mise en place de solutions de relais professionnelles.',
                actor: 'Assistante sociale + IDEC + M√©decin du travail',
                tasks: [
                    'Audit complet des am√©nagements d√©j√† mis en place',
                    'Informer sur le cong√© de proche aidant (CPF de transition, AJPA)',
                    '√âvaluer l\'int√©r√™t d\'un passage √† temps partiel',
                    'Proposer des solutions de r√©pit (accueil de jour, h√©bergement temporaire)',
                    'Organiser une rencontre avec le m√©decin du travail'
                ]
            },
            'R2_CC_01': {
                code: 'R2_CC_01',
                name: 'Aidant seul + soutien quasi-inexistant',
                condition: 'N4=Oui ET E2=Personne',
                reco: 'Mise en place URGENTE d\'un filet de s√©curit√© externe avec mobilisation des dispositifs institutionnels et associatifs.',
                actor: 'IDEC (r√©f√©rent unique) + Assistante sociale + Associations d\'aidants',
                tasks: [
                    'Contact sous 48h par l\'IDEC pour confirmer la situation',
                    'Inscrire l\'aidant √† une association d\'entraide',
                    'Activer un dispositif de "baluchonnage" ou garde itin√©rante',
                    'Mettre en place un suivi rapproch√© par t√©l√©phone (1x/semaine)',
                    'Pr√©parer un plan B en cas d\'urgence',
                    '√âvaluer l\'√©ligibilit√© √† une aide financi√®re (PCH, APA)'
                ]
            },
            'R2_CC_02': {
                code: 'R2_CC_02',
                name: 'Charge exclusive + soutien quasi-inexistant',
                condition: 'E1=Seul ET E2=Personne',
                reco: 'Accompagnement renforc√© pour identifier ou cr√©er un r√©seau de soutien de substitution (professionnels + associatif).',
                actor: 'IDEC + Assistante sociale + M√©diateur familial',
                tasks: [
                    'R√©aliser un sociogramme de l\'entourage',
                    'Si entourage existe mais d√©sengag√© : proposer une m√©diation familiale',
                    'Mettre en place des aides professionnelles',
                    'Orienter vers des groupes de parole',
                    'Activer un dispositif de r√©pit mensuel minimum'
                ]
            },
            'R3_CC_01': {
                code: 'R3_CC_01',
                name: 'Isolement social du proche + faible pr√©sence',
                condition: 'N20=Oui ET O48‚â§1x/mois',
                reco: 'Mise en place d\'une stimulation sociale professionnelle pour le proche et accompagnement de la culpabilit√© de l\'aidant.',
                actor: 'Ergoth√©rapeute + Animateur en g√©rontologie + IDEC',
                tasks: [
                    'Proposer un accueil de jour 2-3 fois/semaine',
                    '√âvaluer les activit√©s adapt√©es √† domicile',
                    'Si refus du proche : envisager des visites √† domicile par b√©n√©voles',
                    'Accompagner l\'aidant sur la gestion de la culpabilit√©',
                    'Cr√©er un lien t√©l√©phonique r√©gulier entre le proche et l\'aidant'
                ]
            },
            'R4_CC_01': {
                code: 'R4_CC_01',
                name: 'Ne plus reconna√Ætre + relation tendue',
                condition: 'O30=Oui ET E4=Tendue',
                reco: 'Accompagnement psychologique urgent de l\'aidant avec psycho√©ducation sur la maladie et m√©diation relationnelle.',
                actor: 'Psychologue (sp√©cialis√© aidants) + IDEC + Neurologue/G√©riatre',
                tasks: [
                    'Proposer sous 7 jours un entretien psychologique individuel',
                    'Organiser une s√©ance de psycho√©ducation',
                    'Proposer des techniques de communication adapt√©es',
                    'Si tensions aigu√´s : envisager un h√©bergement temporaire du proche',
                    'Mettre en place un groupe de parole sp√©cifique "deuil blanc"'
                ]
            },
            'R4_CC_02': {
                code: 'R4_CC_02',
                name: 'Tensions familiales + charge exclusive',
                condition: 'E5=Oui ET E1=Seul',
                reco: 'M√©diation familiale urgente pour clarifier les r√¥les, d√©samorcer les conflits et redistribuer la charge.',
                actor: 'M√©diateur familial + IDEC + Notaire (si conflit patrimonial)',
                tasks: [
                    'Proposer une r√©union familiale sous 15 jours avec m√©diateur neutre',
                    'Cartographier les sources de d√©saccord',
                    'Co-construire un pacte familial avec r√©partition claire',
                    'Si blocage : proposer une aide professionnelle',
                    'Informer sur les recours juridiques si maltraitance'
                ]
            },
            'R4_CC_03': {
                code: 'R4_CC_03',
                name: 'Refus d\'aide ext√©rieure + peur pour l\'avenir',
                condition: 'E6=Refuse ET O31=Oui',
                reco: 'Approche progressive d\'acceptation de l\'aide avec accompagnement de l\'aidant sur l\'anticipation et la gestion de crise.',
                actor: 'IDEC + Psychologue + M√©decin traitant',
                tasks: [
                    'Identifier les causes du refus',
                    'Proposer une approche progressive',
                    'Impliquer le m√©decin traitant pour "prescrire" l\'aide',
                    'Accompagner l\'aidant √† accepter le refus tout en pr√©parant un plan B',
                    'Informer sur les mesures de protection juridique'
                ]
            }
        };

        let answers = {};

        // Micro-Task Type Mapping (based on micro_taches_typologie.md)
        const microTaskTypes = {
            // E1 - R√©partition de l'aide
            "Lister les personnes mobilisables": "ORGA",
            "Lister les personnes de l'entourage mobilisables": "ORGA",
            "Explorer les freins √† une meilleure r√©partition": "ORGA",
            "√âvaluer les aides disponibles": "INFO",
            "√âvaluer les aides disponibles (services, associations)": "INFO",
            "Proposer un accompagnement pour solliciter de l'aide": "SEC",
            "Proposer un accompagnement pour solliciter aide": "SEC",
            "Orienter vers des groupes d'entraide": "INFO",

            // E2 - Soutien mobilisable
            "Identifier d'autres personnes mobilisables": "ORGA",
            "Identifier d'autres personnes potentiellement mobilisables": "ORGA",
            "Informer sur les solutions de r√©pit": "INFO",
            "√âvaluer l'urgence de l'isolement": "ORGA",
            "√âvaluer l'urgence de la situation d'isolement": "ORGA",
            "Proposer un contact r√©gulier avec un professionnel": "SEC",
            "Orienter vers des dispositifs d'aide aux aidants": "INFO",
            "Envisager un accueil temporaire": "STRUC",
            "Envisager un accueil temporaire pour le proche": "STRUC",

            // E4 - √âvolution relation
            "√âchanger sur les sources de tension": "ORGA",
            "√âchanger sur les sources de tension identifi√©es": "ORGA",
            "Proposer un accompagnement psychologique": "SEC",
            "Proposer un accompagnement psychologique si besoin": "SEC",
            "Informer sur les groupes de parole": "INFO",

            // E5 - Tensions familiales
            "Identifier les points de tension r√©currents": "ORGA",
            "Proposer un entretien de m√©diation": "STRUC",
            "Orienter vers des dispositifs de soutien ou m√©diation adapt√©s": "INFO",
            "Orienter vers des dispositifs de soutien": "INFO",

            // E6 - Acceptation aide
            "Comprendre les freins √† l'acceptation": "ORGA",
            "Comprendre les freins √† l'acceptation de l'aide": "ORGA",
            "Proposer un √©change avec le proche": "SEC",
            "Proposer un temps d'√©change avec le proche et l'aidant": "SEC",
            "Explorer les causes du refus": "ORGA",
            "Proposer une approche progressive": "SEC",
            "Informer sur les types d'aides existantes": "INFO",
            "Proposer une premi√®re mise en relation": "SEC",
            "Proposer une premi√®re mise en relation avec un intervenant": "SEC",

            // N4 - Aidant seul
            "√âvaluer les possibilit√©s de mobilisation": "ORGA",
            "√âvaluer les possibilit√©s de mobilisation d'autres membres": "ORGA",
            "Proposer des solutions de r√©pit": "STRUC",
            "Orienter vers des associations": "INFO",
            "Orienter vers des associations d'aide aux aidants": "INFO",

            // O27 - R√©percussions vie familiale
            "Rester attentif aux signaux de d√©gradation": "ORGA",
            "Identifier les domaines impact√©s": "ORGA",
            "Identifier les domaines les plus impact√©s": "ORGA",
            "Proposer un soutien psychologique": "SEC",
            "Orienter vers des solutions de r√©pit": "INFO",

            // O28 - R√©percussions vie sociale/travail
            "Identifier les activit√©s impact√©es": "ORGA",
            "Identifier les activit√©s les plus impact√©es": "ORGA",
            "√âvaluer l'impact professionnel": "ORGA",
            "Informer sur les droits des aidants": "INFO",
            "Proposer des solutions d'am√©nagement": "STRUC",

            // O30 - Sentiment ne plus reconna√Ætre
            "√âchanger sur les changements observ√©s": "ORGA",
            "Informer sur la maladie et son √©volution": "INFO",
            "Orienter vers des groupes de parole": "INFO",

            // N20 - Difficult√©s relationnelles proche
            "Identifier les situations probl√©matiques": "ORGA",
            "Proposer des activit√©s adapt√©es": "STRUC",
            "√âvaluer l'int√©r√™t d'un accueil de jour": "ORGA"
        };

        function getTaskType(taskText) {
            // Normalize task text for matching
            const normalized = taskText.toLowerCase().trim();

            // Try exact match first
            for (const [key, type] of Object.entries(microTaskTypes)) {
                if (key.toLowerCase() === normalized) {
                    return type;
                }
            }

            // Try partial match
            for (const [key, type] of Object.entries(microTaskTypes)) {
                if (normalized.includes(key.toLowerCase()) || key.toLowerCase().includes(normalized)) {
                    return type;
                }
            }

            // Default to ORGA if not found
            return "ORGA";
        }

        function renderMicroTasksList() {
            const container = document.getElementById('microtask-list');
            if (!container) return;

            // Collect all tasks from answered questions
            const allTasks = [];

            Object.entries(answers).forEach(([qId, ans]) => {
                const q = questions.find(q => q.id === qId);
                if (q && q.recommendations && q.recommendations[ans.optionIndex]) {
                    const reco = q.recommendations[ans.optionIndex];
                    if (reco.tasks) {
                        reco.tasks.forEach(taskText => {
                            const type = getTaskType(taskText);
                            allTasks.push({ text: taskText, type: type });
                        });
                    }
                }
            });

            // Also add CCC tasks if any
            const activatedCCC = window.activatedCCCFull || [];
            activatedCCC.forEach(ccc => {
                if (ccc.tasks) {
                    ccc.tasks.forEach(task => {
                        // Handle both task as object with .name OR task as string
                        const taskText = typeof task === 'string' ? task : task.name;
                        if (taskText) {
                            const type = getTaskType(taskText);
                            allTasks.push({ text: taskText, type: type });
                        }
                    });
                }
            });

            // Update statistics
            updateMicroTaskStats(allTasks);

            // Render tasks
            if (allTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <p>R√©pondez aux questions pour voir les micro-t√¢ches recommand√©es</p>
                    </div>
                `;
            } else {
                container.innerHTML = allTasks.map(mt => `
                    <div class="microtask-item">
                        <span class="mt-badge mt-${mt.type.toLowerCase()}">${mt.type}</span>
                        <span class="microtask-text">${mt.text}</span>
                    </div>
                `).join('');
            }
        }

        function updateMicroTaskStats(tasks) {
            // Count by type
            const counts = { STRUC: 0, SEC: 0, MED: 0, INFO: 0, ORGA: 0 };
            tasks.forEach(t => counts[t.type] = (counts[t.type] || 0) + 1);

            const total = tasks.length;
            const contributive = counts.STRUC + counts.SEC + counts.MED;
            const nonContributive = counts.INFO + counts.ORGA;

            // Update contributive count
            const contribEl = document.querySelector('#tab-microtasks .result-section:first-child div > div:first-child > div:first-child');
            if (contribEl) contribEl.textContent = contributive;

            // Update non-contributive count
            const nonContribEl = document.querySelector('#tab-microtasks .result-section:first-child div > div:last-child > div:first-child');
            if (nonContribEl) nonContribEl.textContent = nonContributive;

            // Update distribution bars
            if (total > 0) {
                const updateBar = (type, index) => {
                    const bars = document.querySelectorAll('#tab-microtasks .result-section:nth-child(2) > div > div');
                    if (bars[index]) {
                        const pct = (counts[type] / total * 100).toFixed(1);
                        const bar = bars[index].querySelector('div > div');
                        const label = bars[index].querySelector('span:last-child');
                        if (bar) bar.style.width = pct + '%';
                        if (label) label.textContent = `${counts[type]} (${pct}%)`;
                    }
                };

                updateBar('STRUC', 0);
                updateBar('SEC', 1);
                updateBar('INFO', 2);
                updateBar('ORGA', 3);
                updateBar('MED', 4);
            }

            // Update list title
            const titleEl = document.querySelector('#tab-microtasks .result-section:last-child h4');
            if (titleEl) titleEl.textContent = `Toutes les Micro-T√¢ches (${total})`;
        }

        // Initialize
        function init() {
            renderQuestions();
            renderCCC();
            renderMicroParcours();
            renderMicroTasksList();
            renderPersonas();
            updateResults();
        }

        function renderQuestions() {
            const container = document.getElementById('questionnaire');
            container.innerHTML = questions.map((q, idx) => `
                <div class="question-card ${q.type}">
                    <span class="question-id ${q.type}">${q.id} ‚Äì ${q.type === 'critical' ? '‚ö†Ô∏è Critique' : q.type === 'scoring' ? 'üìä Scorante' : 'üîÄ Trigger'}</span>
                    <div class="question-label">${q.label}</div>
                    <div class="options">
                        ${q.options.map((opt, optIdx) => `
                            <label class="option" id="opt-${q.id}-${optIdx}" onclick="selectOption('${q.id}', ${optIdx})">
                                <div class="radio"></div>
                                <span>${opt.text}</span>
                                ${opt.score > 0 ? `<span class="option-score">+${opt.score}</span>` : ''}
                                ${opt.critical ? '<span class="option-score" style="background: rgba(239,68,68,0.2); color: #ef4444;">üî¥ Critique</span>' : ''}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectOption(questionId, optionIndex) {
            const question = questions.find(q => q.id === questionId);
            const option = question.options[optionIndex];

            answers[questionId] = { optionIndex, score: option.score, critical: option.critical, trigger: option.trigger };

            // Update UI
            question.options.forEach((_, idx) => {
                const el = document.getElementById(`opt-${questionId}-${idx}`);
                el.classList.remove('selected', 'critical-selected');
            });

            const selectedEl = document.getElementById(`opt-${questionId}-${optionIndex}`);
            selectedEl.classList.add(option.critical ? 'critical-selected' : 'selected');

            updateResults();
        }

        function updateResults() {
            // Calculate score
            let rawScore = 0;
            const scoringQuestions = ['E1', 'E2', 'E4', 'E5', 'N20', 'O27', 'O28', 'O30'];
            scoringQuestions.forEach(qId => {
                if (answers[qId]) {
                    rawScore += answers[qId].score;
                }
            });

            const normalizedScore = Math.round((rawScore / 16) * 20 * 10) / 10;

            // Update score display
            document.getElementById('score-raw').textContent = rawScore;
            document.getElementById('score-value').textContent = normalizedScore;

            const circle = document.getElementById('score-circle');
            circle.classList.remove('green', 'orange', 'red');

            let interpretation = '';
            if (normalizedScore <= 6) {
                circle.classList.add('green');
                interpretation = 'üü¢ Situation sociale globalement pr√©serv√©e';
            } else if (normalizedScore <= 13) {
                circle.classList.add('orange');
                interpretation = 'üü† Fragilisation sociale et relationnelle';
            } else {
                circle.classList.add('red');
                interpretation = 'üî¥ Isolement ou rupture relationnelle probable';
            }
            document.getElementById('score-interpretation').textContent = interpretation;

            // Check critical direct
            let hasCritical = false;
            let criticalMessages = [];
            Object.entries(answers).forEach(([qId, ans]) => {
                if (ans.critical) {
                    hasCritical = true;
                    const q = questions.find(q => q.id === qId);
                    criticalMessages.push(`${qId}: ${q.options[ans.optionIndex].text}`);
                }
            });

            // Check CCC
            let activatedCCC = [];
            let activatedCCCFull = [];
            cccRules.forEach(ccc => {
                let activated = false;
                if (ccc.code === 'R1_CC_01' && answers['O27']?.score === 2 && answers['O28']?.score === 2) activated = true;
                if (ccc.code === 'R2_CC_01' && answers['N4']?.optionIndex === 1 && answers['E2']?.score === 2) activated = true;
                if (ccc.code === 'R2_CC_02' && answers['E1']?.score === 2 && answers['E2']?.score === 2) activated = true;
                if (ccc.code === 'R4_CC_01' && answers['O30']?.score === 2 && answers['E4']?.score === 1) activated = true;
                if (ccc.code === 'R4_CC_02' && answers['E5']?.score === 2 && answers['E1']?.score === 2) activated = true;

                if (activated) {
                    activatedCCC.push(ccc);
                    // Store full recommendation object for display
                    if (cccRecommendations[ccc.code]) {
                        activatedCCCFull.push(cccRecommendations[ccc.code]);
                    }
                }
            });

            // Store for use in updateRecommendations
            window.activatedCCCFull = activatedCCCFull;

            // Determine priority
            let priority = 3;
            let priorityLabel = 'Niveau 3 ‚Äì Planifi√© (>1 mois)';
            let priorityClass = 'level-3';
            let priorityIcon = '‚è±Ô∏è';

            if (hasCritical) {
                priority = 1;
                priorityLabel = 'Niveau 1 ‚Äì URGENT (‚â§ 7 jours)';
                priorityClass = 'level-1';
                priorityIcon = 'üö®';
            } else if (activatedCCC.length > 0) {
                priority = 2;
                priorityLabel = 'Niveau 2 ‚Äì Prioritaire (‚â§ 7 jours)';
                priorityClass = 'level-2';
                priorityIcon = '‚ö°';
            }

            document.getElementById('priority-display').innerHTML = `
                <div class="priority-badge ${priorityClass}">
                    <span>${priorityIcon}</span>
                    <span>${priorityLabel}</span>
                </div>
            `;

            // Critical list
            if (hasCritical) {
                document.getElementById('critical-list').innerHTML = criticalMessages.map(msg => `
                    <div class="ccc-item activated">
                        <span class="ccc-status">üö®</span>
                        <span>${msg}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('critical-list').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <p>Aucune alerte critique</p>
                    </div>
                `;
            }

            // Update CCC display
            document.querySelectorAll('.ccc-item').forEach(el => el.classList.remove('activated'));
            activatedCCC.forEach(ccc => {
                const el = document.getElementById(`ccc-${ccc.code}`);
                if (el) el.classList.add('activated');
            });

            // Update micro-parcours
            let activatedMP = new Set();
            if (hasCritical) {
                if (answers['E2']?.critical) activatedMP.add('R2');
                if (answers['E6']?.critical) activatedMP.add('R4');
            }
            activatedCCC.forEach(ccc => activatedMP.add(ccc.mp));
            Object.entries(answers).forEach(([qId, ans]) => {
                if (ans.trigger) activatedMP.add(ans.trigger);
            });

            document.querySelectorAll('.micro-parcours').forEach(el => el.classList.remove('activated'));
            activatedMP.forEach(mp => {
                const el = document.getElementById(`mp-${mp}`);
                if (el) el.classList.add('activated');
            });

            // Update recommendations
            updateRecommendations();

            // Update scoring details
            updateScoringDetails(scoringQuestions);

            // Update micro-tasks list
            renderMicroTasksList();
            renderDynamicJustification();
        }

        function updateScoringDetails(scoringQuestions) {
            const container = document.getElementById('scoring-details');
            container.innerHTML = scoringQuestions.map(qId => {
                const q = questions.find(q => q.id === qId);
                const ans = answers[qId];
                const score = ans ? ans.score : '-';
                const maxScore = qId === 'E4' ? 1 : 2;
                return `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg); border-radius: 0.25rem; margin-bottom: 0.25rem; font-size: 0.875rem;">
                        <span>${qId}</span>
                        <span style="color: ${ans ? 'var(--primary)' : 'var(--text-muted)'};">${score} / ${maxScore}</span>
                    </div>
                `;
            }).join('');
        }

        // Dynamic Justification Tab
        function renderDynamicJustification() {
            const answeredQuestions = Object.keys(answers);
            const answeredCount = answeredQuestions.length;
            const criticalAnswers = answeredQuestions.filter(qId => answers[qId].critical);
            const activatedCCC = window.activatedCCCFull || [];

            // Summary stats
            const summaryHTML = `
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary);">${answeredCount}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">R√©ponses</div>
                </div>
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                    <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;">${answeredQuestions.filter(qId => { const q = questions.find(qu => qu.id === qId); return q?.recommendations?.[answers[qId].optionIndex]; }).length + activatedCCC.length}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Recommandations</div>
                </div>
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                    <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;">${activatedCCC.length}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">CCC Activ√©es</div>
                </div>
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                    <div style="font-size: 1.75rem; font-weight: 700; color: #8b5cf6;">${(() => {
                    let count = 0;
                    answeredQuestions.forEach(qId => {
                        const q = questions.find(qu => qu.id === qId);
                        const reco = q?.recommendations?.[answers[qId].optionIndex];
                        if (reco?.tasks) count += reco.tasks.length;
                    });
                    activatedCCC.forEach(ccc => {
                        if (ccc.tasks) count += ccc.tasks.length;
                    });
                    return count;
                })()}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Micro-T√¢ches</div>
                </div>
            `;
            document.getElementById('justif-summary').innerHTML = summaryHTML;

            // Render decision tree
            renderDecisionTree();
        }

        // Helper function for decision tree rendering
        function renderDecisionTree() {
            const container = document.getElementById('decision-tree-container');
            const answeredQuestions = Object.keys(answers);
            const activatedCCC = window.activatedCCCFull || [];

            if (answeredQuestions.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-muted); font-size: 0.875rem; font-style: italic;">
                        R√©pondez aux questions pour voir l'arbre de d√©cision complet.
                    </p>
                `;
                return;
            }

            // Build tree HTML
            let treeHTML = '';

            answeredQuestions.forEach((qId) => {
                const ans = answers[qId];
                const q = questions.find(qu => qu.id === qId);
                if (!q) return;

                const selectedOption = q.options[ans.optionIndex];
                const reco = q.recommendations?.[ans.optionIndex];
                const isCritical = ans.critical;

                // Question Node
                treeHTML += `
                    <div class="decision-question">
                        <div class="question-header">
                            <span class="question-icon">‚ùì</span>
                            <span class="question-id-badge">${qId}</span>
                            <span class="question-text">${q.label}</span>
                        </div>
                        
                        <div class="decision-flow">
                            <div class="answer-branch">
                                <div class="answer-node ${isCritical ? 'critical' : ''}">
                                    <span class="answer-badge ${isCritical ? 'critical' : ''}">
                                        ${isCritical ? 'üö® CRITIQUE' : '+' + ans.score}
                                    </span>
                                    <span class="answer-text">${selectedOption.text}</span>
                                </div>
                `;

                // Triggers container
                const hasReco = !!reco;
                const hasTasks = reco?.tasks && reco.tasks.length > 0;

                if (hasReco || isCritical) {
                    treeHTML += '<div class="triggers-container">';

                    // Standard recommendation
                    if (hasReco && !isCritical) {
                        const justification = ans.score > 0
                            ? `Score positif (+${ans.score}) - Capacit√© identifi√©e √† valoriser`
                            : `Situation neutre - Pr√©vention recommand√©e selon protocole clinique`;

                        treeHTML += `
                            <div class="trigger-block">
                                <div class="recommendation-trigger">
                                    <div class="trigger-header">
                                        <span class="trigger-icon">üí°</span>
                                        <span class="trigger-label">Recommandation</span>
                                    </div>
                                    <div class="trigger-content">"${reco.reco}"</div>
                                    <div class="trigger-why">
                                        <strong>Pourquoi:</strong> ${justification}
                                    </div>
                                </div>
                        `;

                        // Micro-tasks from recommendation
                        if (hasTasks) {
                            treeHTML += `
                                <div class="microtasks-block">
                                    <div class="microtasks-header">
                                        <span>üìå</span>
                                        <span>${reco.tasks.length} MICRO-T√ÇCHE${reco.tasks.length > 1 ? 'S' : ''}</span>
                                    </div>
                                    <div class="microtasks-list">
                                        ${reco.tasks.map(task => `
                                            <div class="mt-item-compact">
                                                <span class="mt-badge mt-${getTaskType(task).toLowerCase()}">${getTaskType(task)}</span>
                                                <span class="mt-text">${task}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        treeHTML += '</div>'; // close trigger-block
                    }

                    // CCC activation (if critical)
                    if (isCritical) {
                        // Find which CCC was activated by this answer
                        const linkedCCC = activatedCCC.filter(ccc => {
                            return ccc.condition && ccc.condition.includes(qId);
                        });

                        linkedCCC.forEach(ccc => {
                            const cccJustification = `R√©ponse critique d√©tect√©e - Protocole ${ccc.code.split('_')[0]} activ√© pour intervention urgente`;

                            treeHTML += `
                                <div class="trigger-block">
                                    <div class="ccc-trigger">
                                        <div class="ccc-alert">
                                            <span class="ccc-icon">‚ö°</span>
                                            <span class="ccc-label">D√âCLENCHE CCC</span>
                                        </div>
                                        <div class="ccc-code">${ccc.code}</div>
                                        <div class="ccc-name">${ccc.name}</div>
                                        <div class="trigger-why">
                                            <strong>Pourquoi:</strong> ${cccJustification}
                                        </div>
                            `;

                            // CCC Recommendation
                            treeHTML += `
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px dashed rgba(146, 64, 14, 0.3);">
                                    <div style="font-weight: 600; font-size: 0.85rem; color: #92400e; margin-bottom: 0.5rem;">
                                        üìã Recommandation CCC:
                                    </div>
                                    <div style="font-size: 0.8rem; color: #78350f; margin-bottom: 0.75rem;">
                                        "${ccc.recommendation}"
                                    </div>
                            `;

                            // CCC Micro-tasks
                            if (ccc.tasks && ccc.tasks.length > 0) {
                                treeHTML += `
                                    <div class="microtasks-block">
                                        <div class="microtasks-header">
                                            <span>‚ö°</span>
                                            <span>${ccc.tasks.length} MICRO-T√ÇCHE${ccc.tasks.length > 1 ? 'S' : ''} CCC</span>
                                        </div>
                                        <div class="microtasks-list">
                                            ${ccc.tasks.map(task => {
                                    const taskText = typeof task === 'string' ? task : task.name;
                                    return `
                                                    <div class="mt-item-compact">
                                                        <span class="mt-badge mt-${getTaskType(taskText).toLowerCase()}">${getTaskType(taskText)}</span>
                                                        <span class="mt-text">${taskText}</span>
                                                    </div>
                                                `;
                                }).join('')}
                                        </div>
                                    </div>
                                `;
                            }

                            treeHTML += '</div></div></div>'; // close divs
                        });
                    }

                    // No triggers
                    if (!hasReco && !isCritical) {
                        treeHTML += '<div class="no-triggers">Aucun d√©clenchement direct</div>';
                    }

                    treeHTML += '</div>'; // close triggers-container
                } else {
                    treeHTML += '<div class="no-triggers" style="margin-left: 2rem;">Aucun d√©clenchement</div>';
                }

                treeHTML += '</div></div></div>'; // close answer-branch, decision-flow, decision-question
            });

            container.innerHTML = treeHTML;
        }

        function updateRecommendations() {
            const container = document.getElementById('reco-list');

            // Retrieve activated CCC
            const cccActivated = window.activatedCCCFull || [];

            // Classify recommendations by priority level
            let level1 = []; // URGENT: critical direct answers
            let level2 = []; // PRIORITAIRE: CCC-activated
            let level3 = []; // PLANIFI√â: standard

            // Retrieve all recommendations from answered questions
            Object.entries(answers).forEach(([qId, ans]) => {
                const q = questions.find(q => q.id === qId);
                if (q.recommendations && q.recommendations[ans.optionIndex]) {
                    const r = { qId, ...q.recommendations[ans.optionIndex] };

                    // Check if this answer is critical direct
                    if (ans.critical) {
                        r.priority = 1;
                        r.priorityLabel = 'üö® URGENT (‚â§7j)';
                        r.priorityClass = 'level-1';
                        level1.push(r);
                    }
                    // Check if activated by CCC
                    else if (cccActivated.some(ccc => ccc.questions && ccc.questions.includes(qId))) {
                        r.priority = 2;
                        r.priorityLabel = '‚ö° PRIORITAIRE (‚â§1 mois)';
                        r.priorityClass = 'level-2';
                        level2.push(r);
                    }
                    // Standard scoring question
                    else {
                        r.priority = 3;
                        r.priorityLabel = '‚è±Ô∏è PLANIFI√â (>1 mois)';
                        r.priorityClass = 'level-3';
                        level3.push(r);
                    }
                }
            });

            // If no recommendations at all
            if (level1.length === 0 && level2.length === 0 && level3.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üí°</div>
                        <p>R√©pondez aux questions pour voir les recommandations</p>
                    </div>
                `;
                return;
            }

            // Build HTML with sorted recommendations (Level 1 ‚Üí Level 2 ‚Üí Level 3)
            let html = '';

            // Helper function to render recommendation card
            const renderReco = (r) => `
                <div class="reco-card">
                    <span class="priority-badge ${r.priorityClass}">${r.priorityLabel}</span>
                    <div class="reco-header">
                        <span class="reco-question-id">${r.qId}</span>
                        <span class="reco-actor">${r.actor}</span>
                    </div>
                    <div class="reco-text">${r.reco}</div>
                    ${r.tasks?.length ? `
                        <div class="micro-tasks">
                            ${r.tasks.map(t => `<div class="micro-task">${t}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            // Display Level 1 (URGENT)
            if (level1.length > 0) {
                html += '<div style="margin-bottom: 2rem;"><h4 style="color: #ef4444; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"><span>üö®</span> URGENT (‚â§ 7 jours)</h4>';
                html += level1.map(renderReco).join('');
                html += '</div>';
            }

            // Display Level 2 (PRIORITAIRE)
            if (level2.length > 0) {
                html += '<div style="margin-bottom: 2rem;"><h4 style="color: #f59e0b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"><span>‚ö°</span> PRIORITAIRE (‚â§ 1 mois)</h4>';
                html += level2.map(renderReco).join('');
                html += '</div>';
            }

            // Display Level 3 (PLANIFI√â)
            if (level3.length > 0) {
                html += '<div><h4 style="color: #6b7280; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;"><span>‚è±Ô∏è</span> PLANIFI√â (> 1 mois)</h4>';
                html += level3.map(renderReco).join('');
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function renderCCC() {
            const container = document.getElementById('ccc-list');
            container.innerHTML = cccRules.map(ccc => `
                <div class="ccc-item" id="ccc-${ccc.code}">
                    <span class="ccc-status">‚¨ú</span>
                    <span><strong>${ccc.code}</strong>: ${ccc.label}</span>
                </div>
                `).join('');
        }

        function renderMicroParcours() {
            const container = document.getElementById('mp-list');
            container.innerHTML = microParcours.map(mp => `
                <div class="micro-parcours" id="mp-${mp.code}">
                    <span class="mp-code">${mp.code}</span>
                    <span>${mp.name}</span>
                </div>
                `).join('');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // Persona System
        let activePersona = null;

        function renderPersonas() {
            const grid = document.getElementById('persona-grid');
            grid.innerHTML = personas.map(p => `
                <div onclick="loadPersona('${p.id}')" style="
                    background: ${activePersona === p.id ? 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)' : 'var(--bg)'};
                    color: ${activePersona === p.id ? 'white' : 'var(--text)'};
                    border: 2px solid ${activePersona === p.id ? '#8b5cf6' : 'var(--border)'};
                    border-radius: 8px;
                    padding: 0.75rem 0.5rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 0.75rem;
                " onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='${activePersona === p.id ? '#8b5cf6' : 'var(--border)'}'"
                >
                    <div style="font-size: 2.25rem; margin-bottom: 0.5rem;">${p.emoji}</div>
                    <div style="font-weight: 700; font-size: 0.8rem; line-height: 1.2; margin-bottom: 0.375rem;">${p.name.split(',')[0]}</div>
                    <div style="font-size: 0.7rem; opacity: 0.75; margin-bottom: 0.25rem;">${p.name.split(', ')[1]}</div>
                    <div style="font-size: 11px; opacity: 0.9; font-weight: 600;">${p.expectedPriority}</div>
                </div>
            `).join('');
        }

        function loadPersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) return;

            activePersona = personaId;

            // Auto-fill questionnaire
            Object.entries(persona.answers).forEach(([qId, optionIndex]) => {
                const question = questions.find(q => q.id === qId);
                if (question && question.options[optionIndex]) {
                    selectOption(qId, optionIndex);
                }
            });

            // Show persona info
            const infoPanel = document.getElementById('persona-info');
            infoPanel.style.display = 'block';
            infoPanel.innerHTML = `
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <div style="font-size: 2rem;">${persona.emoji}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--primary); margin-bottom: 0.25rem;">${persona.name}</div>
                        <div style="font-size: 0.75rem; line-height: 1.5; color: var(--text-muted);">${persona.situation}</div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <span style="font-size: 10px; padding: 2px 6px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px;">${persona.expectedPriority}</span>
                            <span style="font-size: 10px; padding: 2px 6px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px;">${persona.expectedCCC} CCC attendues</span>
                        </div>
                    </div>
                </div>
            `;

            renderPersonas();
        }

        function resetAll() {
            answers = {};
            activePersona = null;

            document.querySelectorAll('.option').forEach(el => {
                el.classList.remove('selected', 'critical-selected');
            });

            document.getElementById('persona-info').style.display = 'none';
            renderPersonas();
            updateResults();
        }

        // Start
        init();
    </script>
</body>

</html>